{% extends "base.html" %}

{% block body_class %}drafts-page{% endblock %}

{% block title %}Draft Approval Queue - Postly{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/drafts-pro.css') }}">
{% endblock %}

{% block content %}
<div class="drafts-container">
    <span class="drafts-orb orb-one"></span>
    <span class="drafts-orb orb-two"></span>
    <div class="drafts-main-content">
        <!-- Header -->
        <div class="drafts-header">
            <h1 class="drafts-header-title">Draft Approval Queue</h1>
            <p class="drafts-header-subtitle">Review and approve draft posts from team members</p>
        </div>

        <!-- Tabs -->
        <div class="drafts-tabs">
            <button class="drafts-tab active" id="pending-tab" onclick="switchTab('pending')">
                Pending Approval
                <span class="drafts-tab-badge warning" id="pending-count">0</span>
            </button>
            <button class="drafts-tab" id="approved-tab" onclick="switchTab('approved')">
                Approved
                <span class="drafts-tab-badge success" id="approved-count">0</span>
            </button>
            <button class="drafts-tab" id="rejected-tab" onclick="switchTab('rejected')">
                Rejected
                <span class="drafts-tab-badge danger" id="rejected-count">0</span>
            </button>
        </div>

        <!-- Content -->
        <div class="drafts-content">
            <!-- Pending Tab -->
            <div class="drafts-tab-pane active" id="pending-pane">
                <div id="pending-drafts-container">
                    <div class="drafts-loading">
                        <div class="drafts-spinner"></div>
                        <p class="drafts-loading-text">Loading drafts...</p>
                    </div>
                </div>
            </div>

            <!-- Approved Tab -->
            <div class="drafts-tab-pane" id="approved-pane">
                <div id="approved-drafts-container">
                    <div class="drafts-empty-state">
                        <p class="drafts-empty-text">No approved posts yet</p>
                    </div>
                </div>
            </div>

            <!-- Rejected Tab -->
            <div class="drafts-tab-pane" id="rejected-pane">
                <div id="rejected-drafts-container">
                    <div class="drafts-empty-state">
                        <p class="drafts-empty-text">No rejected drafts yet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="draft-modal-overlay" id="reviewModal">
    <div class="draft-modal">
        <div class="draft-modal-header">
            <h2 class="draft-modal-title">Review Draft Post</h2>
            <button class="draft-modal-close" onclick="closeReviewModal()">×</button>
        </div>
        <div class="draft-modal-body">
            <div class="draft-modal-field">
                <label class="draft-modal-label">Submitted by</label>
                <p class="draft-modal-value" id="modal-submitted-by">-</p>
            </div>
            <div class="draft-modal-field">
                <label class="draft-modal-label">Content</label>
                <div class="draft-modal-content-box" id="modal-content">-</div>
            </div>
            <div class="draft-modal-field" id="modal-media-field" hidden>
                <label class="draft-modal-label">Attached Media</label>
                <div class="draft-modal-media" id="modal-media"></div>
            </div>
            <div class="draft-modal-field">
                <label class="draft-modal-label">Publishing to</label>
                <div class="draft-pages" id="modal-pages">-</div>
            </div>
            {% if can_approve_drafts %}
            <div class="draft-modal-field">
                <label class="draft-modal-label">Approval Notes (Optional)</label>
                <textarea class="draft-modal-textarea" id="approval-notes" rows="3" placeholder="Add feedback or notes..."></textarea>
            </div>
            {% endif %}
        </div>
        <div class="draft-modal-footer">
            <button class="draft-modal-btn draft-modal-btn-secondary" onclick="closeReviewModal()">Close</button>
            {% if can_approve_drafts %}
            <button class="draft-modal-btn draft-modal-btn-danger" onclick="showRejectModal()">
                <i class="fas fa-times"></i> Reject
            </button>
            <button class="draft-modal-btn draft-modal-btn-success" onclick="approveDraft()">
                <i class="fas fa-check"></i> Approve
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Reject Confirmation Modal -->
<div class="draft-modal-overlay" id="rejectModal">
    <div class="draft-modal">
        <div class="draft-modal-header">
            <h2 class="draft-modal-title">Reject Draft</h2>
            <button class="draft-modal-close" onclick="closeRejectModal()">×</button>
        </div>
        <div class="draft-modal-body">
            <div class="draft-modal-field">
                <label class="draft-modal-label">Rejection Reason</label>
                <textarea class="draft-modal-textarea" id="rejection-notes" rows="4" placeholder="Explain why this post is being rejected..."></textarea>
            </div>
        </div>
        <div class="draft-modal-footer">
            <button class="draft-modal-btn draft-modal-btn-secondary" onclick="closeRejectModal()">Cancel</button>
            <button class="draft-modal-btn draft-modal-btn-danger" onclick="confirmRejectDraft()">
                <i class="fas fa-times-circle"></i> Confirm Rejection
            </button>
        </div>
    </div>
</div>

<!-- Media Lightbox -->
<div class="draft-media-lightbox" id="draftMediaLightbox" aria-hidden="true">
    <div class="draft-media-lightbox-content" role="dialog" aria-modal="true">
        <button class="draft-media-lightbox-close" id="lightbox-close" onclick="closeMediaLightbox()" aria-label="Close media preview">×</button>
        <div class="draft-media-lightbox-body" id="lightbox-media"></div>
        <div class="draft-media-lightbox-footer">
            <a class="draft-media-lightbox-link" id="lightbox-source-link" href="#" target="_blank" rel="noopener">Open original ↗</a>
        </div>
    </div>
</div>

<script>
    let currentDraftId = null;
    let allDrafts = [];
    let mediaLightboxTrigger = null;
    let bodyOverflowBeforeLightbox = '';

    document.addEventListener('DOMContentLoaded', function() {
        loadDrafts();
        setupMediaInteractions();
    });

    function loadDrafts() {
        const teamId = new URLSearchParams(window.location.search).get('team_id');
        const url = teamId ? `/api/drafts?team_id=${teamId}` : '/api/drafts';

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    allDrafts = data.drafts || [];
                    displayDrafts(allDrafts);
                } else {
                    showError(data.error || 'Failed to load drafts');
                }
            })
            .catch(err => {
                console.error('Error loading drafts:', err);
                showError('Failed to load drafts');
            });
    }

    function displayDrafts(drafts) {
        const pendingContainer = document.getElementById('pending-drafts-container');
        const approvedContainer = document.getElementById('approved-drafts-container');
        const rejectedContainer = document.getElementById('rejected-drafts-container');
        
        const pendingDrafts = drafts.filter(d => d.status === 'pending');
        const approvedDrafts = drafts.filter(d => d.status === 'approved');
        const rejectedDrafts = drafts.filter(d => d.status === 'rejected');
        
        // Update counts
        document.getElementById('pending-count').textContent = pendingDrafts.length;
        document.getElementById('approved-count').textContent = approvedDrafts.length;
        document.getElementById('rejected-count').textContent = rejectedDrafts.length;
        
        // Display Pending Drafts
        if (pendingDrafts.length === 0) {
            pendingContainer.innerHTML = `
                <div class="drafts-empty-state">
                    <p class="drafts-empty-text">No drafts pending approval</p>
                </div>
            `;
        } else {
            pendingContainer.innerHTML = pendingDrafts.map(draft => createDraftCard(draft, 'pending')).join('');
        }
        
        // Display Approved Drafts
        if (approvedDrafts.length === 0) {
            approvedContainer.innerHTML = `
                <div class="drafts-empty-state">
                    <p class="drafts-empty-text">No approved posts yet</p>
                </div>
            `;
        } else {
            approvedContainer.innerHTML = approvedDrafts.map(draft => createDraftCard(draft, 'approved')).join('');
        }
        
        // Display Rejected Drafts
        if (rejectedDrafts.length === 0) {
            rejectedContainer.innerHTML = `
                <div class="drafts-empty-state">
                    <p class="drafts-empty-text">No rejected drafts yet</p>
                </div>
            `;
        } else {
            rejectedContainer.innerHTML = rejectedDrafts.map(draft => createDraftCard(draft, 'rejected')).join('');
        }
    }

    function createDraftCard(draft, status) {
        const statusBadge = status === 'approved' ? 
            '<span class="draft-status-badge approved">APPROVED</span>' :
            status === 'rejected' ?
            '<span class="draft-status-badge rejected">REJECTED</span>' :
            '';
        
        const pages = Array.isArray(draft.pages) ? draft.pages : [];
        const pagesHtml = pages.map(p => {
            const platform = p.platform || 'facebook';
            const icon = platform === 'instagram' ? 'fa-instagram' : 
                        platform === 'tiktok' ? 'fa-tiktok' : 'fa-facebook';
            return `<span class="draft-page-badge"><i class="fab ${icon}"></i>${escapeHtml(p.name)}</span>`;
        }).join('');

        const content = typeof draft.content === 'string' ? draft.content : '';
        const contentPreview = content.length > 200 ? 
            content.substring(0, 200) + '...' : 
            content;

        const mediaHtml = renderCardMedia(draft.media);

        const timestampHtml = `
            <div class="draft-timestamp">
                <strong>Submitted:</strong> ${formatDate(draft.submitted_at)}
                ${draft.approved_by ? `<br><strong>${status === 'rejected' ? 'Rejected' : 'Approved'} by:</strong> ${escapeHtml(draft.approved_by)}` : ''}
                ${draft.approved_at ? `<br><strong>On:</strong> ${formatDate(draft.approved_at)}` : ''}
            </div>
        `;

        const notesHtml = draft.approval_notes ? `
            <div class="draft-notes">
                <div class="draft-notes-label">${status === 'rejected' ? 'Rejection Reason' : 'Approval Notes'}</div>
                <div class="draft-notes-text ${status === 'rejected' ? 'rejection' : ''}">${escapeHtml(draft.approval_notes)}</div>
            </div>
        ` : '';

        const actionButton = status === 'pending' ? `
            <div class="draft-card-actions">
                <button class="btn-review" onclick="reviewDraft(${draft.id})">
                    <i class="fas fa-eye"></i> Review
                </button>
            </div>
        ` : '';

        return `
            <div class="draft-card ${status}">
                <div class="draft-card-header">
                    <div class="draft-card-info">
                        ${statusBadge}
                        <div class="draft-submitted-by">
                            Submitted by: <strong>${escapeHtml(draft.submitted_by)}</strong>
                        </div>
                        ${timestampHtml}
                    </div>
                    ${actionButton}
                </div>
                <div class="draft-content-preview">${escapeHtml(contentPreview)}</div>
                    ${mediaHtml}
                <div class="draft-pages">${pagesHtml}</div>
                ${notesHtml}
            </div>
        `;
    }

    function reviewDraft(draftId) {
        const draft = allDrafts.find(d => d.id === draftId);
        if (!draft) return;

        currentDraftId = draftId;

        document.getElementById('modal-submitted-by').textContent = draft.submitted_by || 'Unknown member';
        document.getElementById('modal-content').textContent = draft.content || '';
        
        const pages = Array.isArray(draft.pages) ? draft.pages : [];
        const pagesHtml = pages.map(p => {
            const platform = p.platform || 'facebook';
            const icon = platform === 'instagram' ? 'fa-instagram' : 
                        platform === 'tiktok' ? 'fa-tiktok' : 'fa-facebook';
            return `<span class="draft-page-badge"><i class="fab ${icon}"></i>${escapeHtml(p.name)}</span>`;
        }).join('');
        document.getElementById('modal-pages').innerHTML = pagesHtml;
        
        renderModalMedia(draft.media);

        const approvalNotes = document.getElementById('approval-notes');
        if (approvalNotes) {
            approvalNotes.value = '';
        }
        
        document.getElementById('reviewModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').classList.remove('show');
        document.body.style.overflow = '';
        renderModalMedia([]);
    }

    function showRejectModal() {
        closeReviewModal();
        document.getElementById('rejection-notes').value = '';
        document.getElementById('rejectModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeRejectModal() {
        document.getElementById('rejectModal').classList.remove('show');
        document.body.style.overflow = '';
    }

    function approveDraft() {
        const approvalNotes = document.getElementById('approval-notes');
        const notes = approvalNotes ? approvalNotes.value : '';
        
        fetch(`/api/drafts/${currentDraftId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                approval_notes: notes
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSuccess('Draft approved successfully!');
                closeReviewModal();
                loadDrafts();
            } else {
                showError(data.error || 'Failed to approve draft');
            }
        })
        .catch(err => {
            console.error('Error approving draft:', err);
            showError('Failed to approve draft');
        });
    }

    function confirmRejectDraft() {
        const notes = document.getElementById('rejection-notes').value;
        
        if (!notes.trim()) {
            showError('Please provide a rejection reason');
            return;
        }
        
        fetch(`/api/drafts/${currentDraftId}/reject`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                rejection_notes: notes
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showSuccess('Draft rejected. Member can edit and resubmit.');
                closeRejectModal();
                loadDrafts();
            } else {
                showError(data.error || 'Failed to reject draft');
            }
        })
        .catch(err => {
            console.error('Error rejecting draft:', err);
            showError('Failed to reject draft');
        });
    }

    function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.drafts-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Update tab panes
        document.querySelectorAll('.drafts-tab-pane').forEach(pane => {
            pane.classList.remove('active');
        });
        document.getElementById(`${tabName}-pane`).classList.add('active');
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function renderCardMedia(mediaItems) {
        const items = Array.isArray(mediaItems) ? mediaItems : [];
        if (!items.length) {
            return '';
        }

        const visibleItems = items.slice(0, 4);
        const thumbnails = visibleItems.map(item => createMediaItemMarkup(item, {
            context: 'card',
            large: items.length === 1,
            autoplay: true
        })).join('');

        const remaining = items.length - visibleItems.length;
        const moreBadge = remaining > 0 ? `<div class="draft-media-item more">+${remaining}</div>` : '';

        if (!thumbnails && !moreBadge) {
            return '';
        }

        return `<div class="draft-media-preview">${thumbnails}${moreBadge}</div>`;
    }

    function renderModalMedia(mediaItems) {
        const mediaField = document.getElementById('modal-media-field');
        const mediaContainer = document.getElementById('modal-media');

        if (!mediaField || !mediaContainer) {
            return;
        }

        const items = Array.isArray(mediaItems) ? mediaItems : [];
        if (!items.length) {
            mediaField.hidden = true;
            mediaContainer.innerHTML = '';
            return;
        }

        const markup = items.map(item => createMediaItemMarkup(item, {
            context: 'modal',
            large: items.length === 1,
            showControls: true
        })).join('');

        if (!markup) {
            mediaField.hidden = true;
            mediaContainer.innerHTML = '';
            return;
        }

        mediaField.hidden = false;
        mediaContainer.innerHTML = markup;
    }

    function createMediaItemMarkup(mediaItem = {}, options = {}) {
        const url = mediaItem.absolute_url || mediaItem.url;
        if (!url) {
            return '';
        }

        const type = (mediaItem.type || '').toLowerCase();
        const isVideo = type.includes('video');
        const classes = ['draft-media-item'];
        if (options.large) {
            classes.push('large');
        }
        if (isVideo) {
            classes.push('is-video');
        }

        const ariaLabel = `Open attached ${isVideo ? 'video' : 'image'} preview`;
        const interactiveAttrs = options.disableLightbox ? '' : ` data-media-url="${escapeHtml(url)}" data-media-type="${isVideo ? 'video' : 'image'}" role="button" tabindex="0" aria-label="${ariaLabel}"`;

        if (isVideo) {
            const videoAttributes = ['muted', 'playsinline', 'loop'];
            if (options.autoplay) {
                videoAttributes.push('autoplay');
            }
            if (options.showControls) {
                videoAttributes.push('controls');
            }
            const attrs = videoAttributes.join(' ');
            return `<div class="${classes.join(' ')}"${interactiveAttrs}><video src="${escapeHtml(url)}" ${attrs} preload="metadata"></video></div>`;
        }

        const altLabel = mediaItem.filename || mediaItem.type || 'Attached media';
        return `<div class="${classes.join(' ')}"${interactiveAttrs}><img src="${escapeHtml(url)}" alt="${escapeHtml(altLabel)}" loading="lazy"></div>`;
    }

    function setupMediaInteractions() {
        document.addEventListener('click', function(event) {
            const mediaNode = event.target.closest('.draft-media-item[data-media-url]');
            if (!mediaNode) {
                return;
            }
            const { mediaUrl, mediaType } = mediaNode.dataset;
            openMediaLightbox(mediaUrl, mediaType, mediaNode);
        });

        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Enter' && event.key !== ' ') {
                if (event.key === 'Escape') {
                    closeMediaLightbox();
                }
                return;
            }
            const target = event.target.closest ? event.target.closest('.draft-media-item[data-media-url]') : null;
            if (!target) {
                return;
            }
            event.preventDefault();
            openMediaLightbox(target.dataset.mediaUrl, target.dataset.mediaType, target);
        });

        const lightbox = document.getElementById('draftMediaLightbox');
        if (lightbox) {
            lightbox.addEventListener('click', function(event) {
                if (event.target === lightbox) {
                    closeMediaLightbox();
                }
            });
        }
    }

    function openMediaLightbox(url, type = 'image', triggerEl = null) {
        if (!url) {
            return;
        }

        const lightbox = document.getElementById('draftMediaLightbox');
        const mediaWrapper = document.getElementById('lightbox-media');
        const sourceLink = document.getElementById('lightbox-source-link');
        const closeBtn = document.getElementById('lightbox-close');
        if (!lightbox || !mediaWrapper || !sourceLink) {
            window.open(url, '_blank');
            return;
        }

        mediaLightboxTrigger = triggerEl;
        let mediaHtml = '';
        if ((type || '').toLowerCase().includes('video')) {
            mediaHtml = `<video src="${escapeHtml(url)}" controls autoplay playsinline></video>`;
        } else {
            mediaHtml = `<img src="${escapeHtml(url)}" alt="Draft media preview">`;
        }

        mediaWrapper.innerHTML = mediaHtml;
        sourceLink.href = url;
        lightbox.classList.add('show');
        lightbox.setAttribute('aria-hidden', 'false');
        bodyOverflowBeforeLightbox = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
        if (closeBtn) {
            closeBtn.focus();
        }
    }

    function closeMediaLightbox() {
        const lightbox = document.getElementById('draftMediaLightbox');
        const mediaWrapper = document.getElementById('lightbox-media');
        if (!lightbox || !mediaWrapper) {
            return;
        }
        lightbox.classList.remove('show');
        lightbox.setAttribute('aria-hidden', 'true');
        mediaWrapper.innerHTML = '';
        document.body.style.overflow = bodyOverflowBeforeLightbox || '';
        bodyOverflowBeforeLightbox = '';
        if (mediaLightboxTrigger) {
            mediaLightboxTrigger.focus();
            mediaLightboxTrigger = null;
        }
    }

    function showError(message) {
        alert(message);
    }

    function showSuccess(message) {
        alert(message);
    }

    // Close modals on overlay click
    document.getElementById('reviewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeReviewModal();
        }
    });

    document.getElementById('rejectModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeRejectModal();
        }
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeReviewModal();
            closeRejectModal();
            closeMediaLightbox();
        }
    });
</script>

<style>
    body {
        margin: 0;
        overflow-x: hidden;
    }
</style>
{% endblock %}
