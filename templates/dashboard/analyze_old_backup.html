{% extends "base.html" %}

{% block title %}Analyze - Postly Analytics Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/analyze.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="analyze-container">
    <div class="analyze-main-content">
        <!-- Header - Buffer Style: Clean & Modern -->
        <div class="analyze-header">
            <div class="analyze-header-left">
                <h1 class="analyze-header-title">Analytics</h1>
                <p class="analyze-header-subtitle">Track performance and discover insights across all your channels</p>
            </div>
            <div class="analyze-header-actions">
                <div class="page-selector" id="pageSelectorContainer" style="display: none;">
                    <select class="page-dropdown" id="pageSelector" onchange="selectPage()" aria-label="Filter by page">
                        <option value="">All Channels</option>
                    </select>
                </div>
                <div class="header-actions-group">
                    <button class="btn-secondary" onclick="exportAnalytics()" title="Export analytics data" aria-label="Export data">
                        <i class="fas fa-download"></i>
                        <span class="btn-text">Export</span>
                    </button>
                    <button class="refresh-btn" id="refreshAnalyticsBtn" onclick="refreshAnalytics()" title="Refresh next 5 posts" aria-label="Refresh metrics">
                        <i class="fas fa-sync-alt"></i>
                        <span id="refreshBtnText" class="btn-text">Refresh</span>
                    </button>
                    <button class="refresh-btn refresh-all-btn" id="refreshAllBtn" onclick="refreshAllPosts()" title="Auto-refresh all posts in batches" aria-label="Refresh all posts">
                        <i class="fas fa-bolt"></i>
                        <span class="btn-text">Refresh All</span>
                    </button>
                </div>
                <div id="refreshProgress" class="refresh-progress" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span id="progressText">Processing...</span>
                </div>
            </div>
        </div>

        <!-- Date Range & Filters - Buffer Style -->
        <div class="date-range-selector">
            <div class="date-range-buttons">
                <button class="date-range-btn {% if request.args.get('days', '30') == '7' %}active{% endif %}" data-range="7" onclick="selectDateRange(7, this)" aria-label="Last 7 days">
                    <span>Last 7 days</span>
                </button>
                <button class="date-range-btn {% if request.args.get('days', '30') in ['30', None] %}active{% endif %}" data-range="30" onclick="selectDateRange(30, this)" aria-label="Last 30 days">
                    <span>Last 30 days</span>
                </button>
                <button class="date-range-btn {% if request.args.get('days', '30') == '90' %}active{% endif %}" data-range="90" onclick="selectDateRange(90, this)" aria-label="Last 90 days">
                    <span>Last 90 days</span>
                </button>
            </div>
            <div class="date-range-info">
                <div class="last-updated" id="lastUpdated">
                    <i class="fas fa-clock"></i>
                    <span>Loading...</span>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="analyze-tabs">
            <button class="analyze-tab active" data-tab="overview" onclick="switchTab('overview')">
                Overview
            </button>
            <button class="analyze-tab" data-tab="posts" onclick="switchTab('posts')">
                Posts
            </button>
        </div>
        
        <!-- Buffer-style: Data Summary Info -->
        <div style="padding: 1rem 2rem; background-color: #f0f2ff; border-bottom: 1px solid #e8eaed; font-size: 13px; color: #5f6368; display: flex; align-items: center; gap: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-calendar" style="color: #2c4bff;"></i>
                <span><strong>Date Range:</strong> Last {{ selected_days }} days</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-file-alt" style="color: #2c4bff;"></i>
                <span><strong>Posts Shown:</strong> {{ total_posts_count }} posts</span>
            </div>
            {% if total_posts_count >= per_page %}
            <div style="margin-left: auto; font-size: 11px; color: #9aa0a6;">
                <i class="fas fa-info-circle"></i> Showing {{ per_page }} posts per page
            </div>
            {% endif %}
        </div>

        <!-- Content -->
        <div class="analyze-content">
            <!-- Overview Tab -->
            <div class="tab-content active" id="overview">
                <div id="overviewContent">
                    <!-- Key Metrics Overview - Buffer Style: Larger, Cleaner -->
                    <div class="metrics-overview">
                        <div class="metric-summary-card">
                            <div class="metric-label">Total Reach</div>
                            <div class="metric-value" id="totalReach">0</div>
                            <div class="metric-change" id="reachChange">Unique people</div>
                        </div>
                        <div class="metric-summary-card">
                            <div class="metric-label">Engagement Rate</div>
                            <div class="metric-value metric-value-accent" id="avgEngagement">0%</div>
                            <div class="metric-change" id="engagementChange">Average rate</div>
                        </div>
                        <div class="metric-summary-card">
                            <div class="metric-label">Link Clicks</div>
                            <div class="metric-value" id="totalClicks">0</div>
                            <div class="metric-change" id="clicksChange">Total clicks</div>
                        </div>
                        <div class="metric-summary-card">
                            <div class="metric-label">Video Views</div>
                            <div class="metric-value" id="totalVideoViews">0</div>
                            <div class="metric-change" id="videoPostsCount">No videos</div>
                        </div>
                    </div>

                    <!-- TIER 1: CHANNEL LEVEL ANALYTICS (Buffer-style) -->
                    <div style="background: #ffffff; padding: 28px; border-radius: 10px; border: 1px solid #e8eaed; margin-bottom: 24px;">
                        <div style="margin-bottom: 24px;">
                            <h2 style="margin: 0 0 6px 0; font-size: 18px; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 24px;">üìä</span>
                                Channel Overview
                            </h2>
                            <p style="margin: 0; font-size: 13px; color: #9aa0a6;">Performance comparison across all your connected social channels</p>
                        </div>
                        
                        <div id="channelOverviewCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px;">
                            {% if channel_insights %}
                                {% for platform, insights in channel_insights.items() %}
                                <div class="channel-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 20px; border-radius: 8px; border: 1px solid #e8eaed; transition: all 0.2s ease;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                                        <div>
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                                {% if platform.lower() == 'facebook' %}
                                                <span style="font-size: 28px;">üìò</span>
                                                {% elif platform.lower() == 'instagram' %}
                                                <span style="font-size: 28px;">üì∑</span>
                                                {% elif platform.lower() == 'tiktok' %}
                                                <span style="font-size: 28px;">üéµ</span>
                                                {% else %}
                                                <span style="font-size: 28px;">üì±</span>
                                                {% endif %}
                                                <h3 style="margin: 0; font-size: 17px; font-weight: 700; color: #1a1a1a; text-transform: capitalize;">{{ platform }}</h3>
                                            </div>
                                            <div style="font-size: 11px; color: #9aa0a6; font-weight: 500;">
                                                {{ insights.page_count }} page{{ 's' if insights.page_count != 1 else '' }} ‚Ä¢ {{ insights.total_posts }} post{{ 's' if insights.total_posts != 1 else '' }}
                                            </div>
                                        </div>
                                        <div style="background: {% if insights.avg_engagement_rate >= 5 %}#10b981{% elif insights.avg_engagement_rate >= 2 %}#f59e0b{% else %}#6b7280{% endif %}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; color: white;">
                                            {{ insights.avg_engagement_rate }}% Avg
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 14px; background: white; border-radius: 6px; border: 1px solid #f0f0f0; margin-bottom: 12px;">
                                        <div>
                                            <div style="font-size: 18px; font-weight: 700; color: #2c4bff;">{{ insights.total_reach|default(0)|int|string|replace(',', '') | int | format_number }}</div>
                                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Reach</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 18px; font-weight: 700; color: #1a1a1a;">{{ (insights.total_likes + insights.total_comments + insights.total_shares)|int|string|replace(',', '') | int | format_number }}</div>
                                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Engage</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 18px; font-weight: 700; color: #1a1a1a;">{{ insights.total_clicks|default(0)|int|string|replace(',', '') | int | format_number }}</div>
                                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Clicks</div>
                                        </div>
                                    </div>
                                    
                                    {% if insights.best_page %}
                                    <div style="background: #f0f9ff; padding: 10px 12px; border-radius: 6px; border-left: 2px solid #3b82f6;">
                                        <div style="font-size: 10px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 3px;">Top Performer</div>
                                        <div style="font-size: 12px; font-weight: 600; color: #1a1a1a;">{{ insights.best_page.page_name }}</div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 2px;">{{ insights.best_page.avg_engagement_rate }}% engagement rate</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if insights.video_posts_count > 0 %}
                                    <div style="margin-top: 10px; padding: 10px 12px; background: #faf5ff; border-radius: 6px; border-left: 2px solid #8b5cf6;">
                                        <div style="font-size: 11px; color: #6b7280;">
                                            <span style="font-weight: 700; color: #8b5cf6;">{{ insights.video_posts_count }}</span> video post{{ 's' if insights.video_posts_count != 1 else '' }} ‚Ä¢
                                            <span style="font-weight: 700; color: #8b5cf6;">{{ insights.total_video_views|int|string|replace(',', '') | int | format_number }}</span> views
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            {% else %}
                            <div style="text-align: center; padding: 40px; color: #9aa0a6; font-size: 13px; grid-column: 1 / -1;">
                                No channel data available. Connect social media pages to see insights.
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- TIER 2: PAGE LEVEL ANALYTICS (From broad to specific) -->
                    
                    <!-- Platform Performance Breakdown -->
                    <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Platform Performance</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Engagement distribution across platforms</p>
                        </div>
                        <canvas id="platformPerformanceChart" style="max-height: 260px;"></canvas>
                    </div>

                    <!-- Page Performance Comparison Section -->
                    <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 20px;" id="pageComparisonSection">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Page Performance Comparison</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Compare engagement and reach across your pages</p>
                        </div>
                        <canvas id="pageComparisonChart" style="max-height: 300px;"></canvas>
                    </div>

                    <!-- Page Insights -->
                    <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 20px;">
                        <div style="margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">üìÑ Page Performance Rankings</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Top performing pages ranked by engagement rate</p>
                        </div>
                        <div id="pageInsightsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9aa0a6; font-size: 13px;">No page data available</div>
                        </div>
                    </div>

                    <!-- Actionable Recommendations with Buffer-style intelligence -->
                    <div style="background: linear-gradient(135deg, #f0f9ff 0%, #f8f9fa 100%); padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 28px;" id="recommendationsSection">
                        <div style="margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">üí° Smart Recommendations</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">AI-powered insights to improve your social media strategy</p>
                        </div>
                        <div id="recommendationsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 10px;">
                            <div style="background: #ffffff; padding: 14px; border-radius: 6px; border: 1px solid #e8eaed;">
                                <div style="color: #9aa0a6; font-size: 12px;">Analyzing your data...</div>
                            </div>
                        </div>
                    </div>

                    <!-- POST LEVEL ANALYTICS -->
                    
                    <!-- Post Performance Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <!-- Engagement Rate Trend -->
                        <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed;">
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Engagement Trend</h3>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Post engagement over time</p>
                            </div>
                            <canvas id="engagementTrendChart" style="max-height: 260px;"></canvas>
                        </div>

                        <!-- Reach Distribution -->
                        <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed;">
                            <div style="margin-bottom: 20px;">
                                <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Reach by Post</h3>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">People reached per post</p>
                            </div>
                            <canvas id="reachDistributionChart" style="max-height: 260px;"></canvas>
                        </div>
                    </div>

                    <!-- Top Performing Posts -->
                    <div style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 20px;">
                        <div style="margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Top Performing Posts</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Highest engagement posts</p>
                        </div>
                        <div id="topPostsList" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="text-align: center; padding: 40px; color: #9aa0a6; font-size: 13px;">No posts data available</div>
                        </div>
                    </div>

                    <!-- Video Performance (shown only if video posts exist) -->
                    <div id="videoPerformanceSection" style="background: #ffffff; padding: 24px; border-radius: 8px; border: 1px solid #e8eaed; margin-bottom: 20px; display: none;">
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 15px; font-weight: 600; color: #1a1a1a;">Video Performance</h3>
                            <p style="margin: 4px 0 0 0; font-size: 12px; color: #9aa0a6;">Video views and reach</p>
                        </div>
                        <canvas id="videoPerformanceChart" style="max-height: 260px;"></canvas>
                    </div>

                    <div class="analyze-empty-state" id="emptyStateOverview" style="display: none;">
                        <div class="analyze-empty-icon">üìä</div>
                        <p class="analyze-empty-text">No data available</p>
                        <p class="analyze-empty-subtext">Connect a page and publish posts to see analytics</p>
                    </div>
                </div>
            </div>

            <!-- Posts Tab -->
            <div class="tab-content" id="posts">
                <div id="postsContent">
                    <div class="analyze-empty-state">
                        <div class="analyze-empty-icon">üìù</div>
                        <p class="analyze-empty-text">No posts yet</p>
                        <p class="analyze-empty-subtext">Publish posts to see detailed analytics</p>
                    </div>
                </div>
                
                <!-- Buffer-style: Load More Button -->
                {% if total_posts_count >= per_page %}
                <div style="text-align: center; margin-top: 2rem; padding: 2rem;">
                    <button onclick="loadMorePosts()" class="load-more-btn" style="padding: 0.75rem 2rem; background-color: #fff; border: 2px solid #e8eaed; border-radius: 8px; font-size: 14px; font-weight: 600; color: #5f6368; cursor: pointer; transition: all 0.2s;">
                        Load More Posts
                    </button>
                    <p style="margin-top: 0.75rem; font-size: 12px; color: #9aa0a6;">
                        Showing {{ total_posts_count }} of {{ total_posts_count }} posts
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Post Detail Modal - Buffer Style -->
<div class="post-detail-modal" id="postDetailModal">
    <div class="post-detail-modal-content">
        <!-- Modal Header -->
        <div class="modal-header">
            <h2>Post details</h2>
            <button class="modal-close" onclick="closePostDetail()">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body with Two-Column Layout -->
        <div class="modal-body">
            <!-- Left Sidebar -->
            <div class="modal-sidebar">
                <!-- Post Media -->
                <div class="post-media" id="postMediaContainer">
                    <div class="media-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                    </div>
                </div>

                <!-- Post Info -->
                <div class="post-info-section">
                    <div class="info-label">Posted on</div>
                    <div class="info-value" id="postDetailDate"></div>
                </div>

                <div class="post-info-section">
                    <div class="info-label">Channels</div>
                    <div class="info-channels" id="postDetailPages"></div>
                </div>

                <div class="post-info-section">
                    <div class="info-label">Caption</div>
                    <div class="info-caption" id="postDetailCaption"></div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="modal-main">
                <!-- Performance Overview -->
                <div class="metrics-section">
                    <h3 class="section-title">Performance</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Impressions</div>
                            <div class="metric-value" id="detailImpressions">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Reach</div>
                            <div class="metric-value" id="detailReach">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Clicks</div>
                            <div class="metric-value" id="detailClicks">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Engagement Rate</div>
                            <div class="metric-value" id="detailEngagementRate">0%</div>
                        </div>
                    </div>
                    <div class="metrics-grid" id="detailVideoMetrics" style="margin-top: 12px; display: none;">
                        <div class="metric-card">
                            <div class="metric-label">Video Views</div>
                            <div class="metric-value" id="detailVideoViews">0</div>
                        </div>
                    </div>
                </div>

                <!-- Engagement Breakdown -->
                <div class="metrics-section">
                    <h3 class="section-title">Engagement</h3>
                    <div class="engagement-grid">
                        <div class="engagement-item">
                            <div class="engagement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                            </div>
                            <div class="engagement-data">
                                <div class="engagement-value" id="detailLikes">0</div>
                                <div class="engagement-label">Likes</div>
                            </div>
                        </div>
                        <div class="engagement-item">
                            <div class="engagement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div class="engagement-data">
                                <div class="engagement-value" id="detailComments">0</div>
                                <div class="engagement-label">Comments</div>
                            </div>
                        </div>
                        <div class="engagement-item">
                            <div class="engagement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="23 4 23 10 17 10"></polyline>
                                    <polyline points="1 20 1 14 7 14"></polyline>
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                                </svg>
                            </div>
                            <div class="engagement-data">
                                <div class="engagement-value" id="detailShares">0</div>
                                <div class="engagement-label">Shares</div>
                            </div>
                        </div>
                        <div class="engagement-item">
                            <div class="engagement-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div class="engagement-data">
                                <div class="engagement-value" id="detailSaves">0</div>
                                <div class="engagement-label">Saves</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Build flat list of all pages from pages_by_platform
    let allPages = [];
    {% if pages_by_platform %}
        {% for platform, pages in pages_by_platform.items() %}
            {% for page in pages %}
                allPages.push({
                    id: {{ page.id }},
                    page_name: '{{ page.page_name | replace("'", "\\'") }}',
                    platform: '{{ page.platform }}'
                });
            {% endfor %}
        {% endfor %}
    {% endif %}
    
    let allPosts = {{ user_posts | tojson | safe }};
    let selectedPage = null;
    let selectedDateRange = {{ request.args.get('days', 30) }};  // Get from URL parameter (Buffer-style)
    let cachedSummary = null;  // Buffer-style Tier 1 cached data
    let lastUpdatedTime = null;

    // Debug: Log the data structure
    console.log('All pages:', allPages);
    console.log('All posts:', allPosts);

    // Initialize with Buffer's 3-tier approach
    document.addEventListener('DOMContentLoaded', function() {
        // TIER 1: Load cached summary first (fastest - Buffer style)
        loadCachedSummary();
        
        // Show loading state for other sections
        showLoadingState();
        
        // TIER 2: Load analytics with requestIdleCallback (non-blocking)
        if ('requestIdleCallback' in window) {
            requestIdleCallback(() => {
                populatePageSelector();
                loadAnalytics();  // This loads the detailed post data
                hideLoadingState();
            });
        } else {
            setTimeout(() => {
                populatePageSelector();
                loadAnalytics();
                hideLoadingState();
            }, 0);
        }
    });
    
    // Buffer-style Tier 1: Fast cached summary load
    async function loadCachedSummary() {
        try {
            const response = await fetch(`/api/analytics-summary?days=${selectedDateRange}`);
            const data = await response.json();
            
            if (data.success && data.cached) {
                cachedSummary = data.summary;
                lastUpdatedTime = data.last_updated;
                
                // Update summary cards immediately with cached data
                document.getElementById('totalReach').textContent = cachedSummary.total_reach.toLocaleString();
                document.getElementById('avgEngagement').textContent = cachedSummary.avg_engagement_rate.toFixed(1) + '%';
                document.getElementById('totalClicks').textContent = cachedSummary.total_clicks.toLocaleString();
                document.getElementById('totalVideoViews').textContent = cachedSummary.total_video_views.toLocaleString();
                
                // Update last updated timestamp
                updateLastUpdatedDisplay();
            }
        } catch (error) {
            console.log('No cached summary available, using fresh data');
        }
    }
    
    // Update "Last updated" display (Buffer-style)
    function updateLastUpdatedDisplay() {
        const lastUpdatedEl = document.getElementById('lastUpdated');
        if (lastUpdatedTime) {
            const updatedDate = new Date(lastUpdatedTime);
            const now = new Date();
            const diffMs = now - updatedDate;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMins = Math.floor(diffMs / (1000 * 60));
            
            let timeText = '';
            if (diffHours >= 24) {
                const diffDays = Math.floor(diffHours / 24);
                timeText = `Updated ${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else if (diffHours >= 1) {
                timeText = `Updated ${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffMins >= 1) {
                timeText = `Updated ${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            } else {
                timeText = 'Updated just now';
            }
            
            lastUpdatedEl.innerHTML = `<i class=\"fas fa-clock\"></i><span>${timeText}</span>`;
        } else {
            lastUpdatedEl.innerHTML = '<i class=\"fas fa-sync-alt fa-spin\"></i><span>Loading...</span>';
        }
    }
    
    function showLoadingState() {
        // Add loading indicators to metric cards
        document.querySelectorAll('.metric-summary-card').forEach(card => {
            card.style.opacity = '0.6';
        });
    }
    
    function hideLoadingState() {
        // Remove loading indicators
        document.querySelectorAll('.metric-summary-card').forEach(card => {
            card.style.opacity = '1';
        });
    }

    function populatePageSelector() {
        const pageSelector = document.getElementById('pageSelector');
        const pageContainer = document.getElementById('pageSelectorContainer');
        
        if (allPages && allPages.length > 0) {
            pageContainer.style.display = 'flex';
            pageSelector.innerHTML = '<option value="">All Pages</option>';
            allPages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.id;
                const icon = page.platform === 'instagram' ? 'üì∑' : page.platform === 'tiktok' ? 'üéµ' : 'üìò';
                option.textContent = `${icon} ${page.page_name}`;
                pageSelector.appendChild(option);
            });
        }
    }

    function selectPage() {
        selectedPage = document.getElementById('pageSelector').value || null;
        loadAnalytics();
        
        // Update page comparison charts based on selected page
        const pageMetricsData = {{ page_metrics | tojson | safe }} || [];
        const platformMetricsData = {{ platform_metrics | tojson | safe }} || [];
        
        if (selectedPage) {
            // Filter to show only selected page
            const filteredPageMetrics = pageMetricsData.filter(p => p.page_id == selectedPage);
            const selectedPageData = pageMetricsData.find(p => p.page_id == selectedPage);
            
            if (selectedPageData) {
                // Update platform metrics for selected page only
                const filteredPlatformMetrics = [{
                    platform: selectedPageData.platform,
                    total_posts: selectedPageData.total_posts,
                    total_reach: selectedPageData.total_reach,
                    total_engagement: selectedPageData.total_engagement,
                    total_clicks: selectedPageData.total_clicks,
                    page_count: 1,
                    avg_engagement_rate: selectedPageData.avg_engagement_rate
                }];
                
                renderPageComparisonChart(filteredPageMetrics);
                renderPlatformPerformanceChart(filteredPlatformMetrics);
                renderPageInsights(filteredPageMetrics);
                renderRecommendations(filteredPageMetrics, filteredPlatformMetrics);
            }
        } else {
            // Show all pages
            renderPageComparisonChart(pageMetricsData);
            renderPlatformPerformanceChart(platformMetricsData);
            renderPageInsights(pageMetricsData);
            renderRecommendations(pageMetricsData, platformMetricsData);
        }
    }

    function selectDateRange(days, button) {
        selectedDateRange = days;
        document.querySelectorAll('.date-range-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        
        // Buffer-style: Reload page with date filter parameter
        const url = new URL(window.location);
        url.searchParams.set('days', days);
        window.location.href = url.toString();
    }

    let isRefreshing = false;
    let autoRefreshActive = false;

    function refreshAnalytics() {
        if (isRefreshing) return;
        
        // Get the refresh button
        const refreshBtn = document.getElementById('refreshAnalyticsBtn');
        const refreshAllBtn = document.getElementById('refreshAllBtn');
        const refreshBtnText = document.getElementById('refreshBtnText');
        const progressDiv = document.getElementById('refreshProgress');
        const progressText = document.getElementById('progressText');
        
        isRefreshing = true;
        
        // Show loading state
        refreshBtn.classList.add('loading');
        refreshBtn.disabled = true;
        refreshAllBtn.disabled = true;
        progressDiv.style.display = 'flex';
        progressDiv.style.alignItems = 'center';
        progressText.textContent = 'Refreshing posts...';
        
        // Make the API call
        fetch('/api/refresh-analytics', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            isRefreshing = false;
            
            // Remove loading state
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
            refreshAllBtn.disabled = false;
            
            if (data.success) {
                const processed = data.processed || data.success_count;
                const total = data.total_posts || processed;
                const remaining = data.remaining || 0;
                
                // Update progress display
                if (remaining > 0) {
                    progressText.innerHTML = `<strong>Refreshed ${processed}/${total} posts</strong> - ${remaining} remaining. <a href="#" onclick="refreshAnalytics(); return false;" style="color: #1a73e8; text-decoration: underline; margin-left: 8px;">Continue</a>`;
                    refreshBtnText.textContent = `Continue (${remaining} left)`;
                    
                    // If auto-refresh is active, continue automatically
                    if (autoRefreshActive) {
                        setTimeout(() => refreshAnalytics(), 1000);
                    }
                } else {
                    progressText.innerHTML = `<i class="fas fa-check-circle" style="color: #0f9d58; margin-right: 6px;"></i><strong>Complete!</strong> Refreshed ${processed} posts`;
                    refreshBtnText.textContent = 'Refresh Metrics';
                    autoRefreshActive = false;
                    
                    // Reload the page after 2 seconds to show new data
                    setTimeout(() => window.location.reload(), 2000);
                }
            } else {
                progressDiv.style.display = 'none';
                alert('Error: ' + (data.error || 'Failed to refresh analytics'));
            }
        })
        .catch(error => {
            isRefreshing = false;
            autoRefreshActive = false;
            
            // Remove loading state
            refreshBtn.classList.remove('loading');
            refreshBtn.disabled = false;
            refreshAllBtn.disabled = false;
            progressDiv.style.display = 'none';
            
            console.error('Error:', error);
            alert('Error refreshing analytics: ' + error.message);
        });
    }

    function refreshAllPosts() {
        if (isRefreshing || autoRefreshActive) return;
        
        if (!confirm('This will automatically refresh all posts in batches. This may take several minutes. Continue?')) {
            return;
        }
        
        autoRefreshActive = true;
        refreshAnalytics();
    }

    function stopAutoRefresh() {
        autoRefreshActive = false;
        const progressText = document.getElementById('progressText');
        const refreshBtnText = document.getElementById('refreshBtnText');
        progressText.innerHTML += ' <span style="color: #d93025;">(Stopped)</span>';
        refreshBtnText.textContent = 'Refresh Metrics';
    }

    // Export analytics data - Buffer Style
    function exportAnalytics() {
        const posts = getFilteredPosts();
        if (posts.length === 0) {
            alert('No data to export');
            return;
        }

        // Create CSV content
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Post Caption,Posted Date,Platform,Impressions,Reach,Clicks,Likes,Comments,Shares,Engagement Rate\n";
        
        posts.forEach(post => {
            const analytics = post.analytics;
            const caption = (post.caption || post.content || 'No caption').replace(/,/g, ';').replace(/\n/g, ' ');
            const date = new Date(post.scheduled_time || post.sent_time).toLocaleDateString();
            const platform = post.pages && post.pages.length > 0 ? post.pages[0].platform : 'Unknown';
            const engagementRate = analytics.reach > 0 
                ? (((analytics.likes + analytics.comments + analytics.shares + analytics.clicks) / analytics.reach) * 100).toFixed(2)
                : '0.00';
            
            csvContent += `"${caption}",${date},${platform},${analytics.impressions},${analytics.reach},${analytics.clicks},${analytics.likes},${analytics.comments},${analytics.shares},${engagementRate}%\n`;
        });

        // Create download link
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `postly-analytics-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function switchTab(tabName) {
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update content display
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');
    }

    function loadAnalytics() {
        const overviewContent = document.getElementById('overviewContent');
        const postsContent = document.getElementById('postsContent');

        // Get posts for selected page (or all if no page selected)
        const filteredPosts = getFilteredPosts();
        
        console.log('Filtered posts:', filteredPosts);
        console.log('Number of filtered posts:', filteredPosts.length);

        if (filteredPosts.length === 0) {
            overviewContent.innerHTML = `
                <div class="analyze-empty-state">
                    <div class="analyze-empty-icon">üìä</div>
                    <p class="analyze-empty-text">No data available</p>
                    <p class="analyze-empty-subtext">Publish posts to see analytics</p>
                </div>
            `;
            postsContent.innerHTML = `
                <div class="analyze-empty-state">
                    <div class="analyze-empty-icon">üìù</div>
                    <p class="analyze-empty-text">No posts yet</p>
                    <p class="analyze-empty-subtext">Publish posts to see detailed analytics</p>
                </div>
            `;
            return;
        }

        // Calculate metrics
        const metrics = calculateMetrics(filteredPosts);
        renderOverview(metrics, filteredPosts);
        renderPostDetails(filteredPosts);
    }

    function getPostAnalyticsForPage(post) {
        // Get analytics for the post filtered by selected page
        if (!post.pages) return null;
        
        // If a specific page is selected, find that page's analytics
        if (selectedPage) {
            const matchingPage = post.pages.find(p => p.page_id == selectedPage);
            return matchingPage ? matchingPage.analytics : null;
        }
        
        // If no specific page selected, aggregate all analytics for this post
        // Use the first page's analytics as representative
        return post.pages.length > 0 ? post.pages[0].analytics : null;
    }

    function getFilteredPosts() {
        // If no page selected, show all posts
        if (!selectedPage) {
            return allPosts.map(post => ({
                ...post,
                analytics: getPostAnalyticsForPage(post) || {
                    impressions: 0,
                    reach: 0,
                    clicks: 0,
                    likes: 0,
                    comments: 0,
                    shares: 0,
                    saves: 0
                }
            }));
        }

        // Filter posts that were published to the selected page
        return allPosts.filter(post => {
            if (!post.pages) return false;
            return post.pages.some(p => p.page_id == selectedPage);
        }).map(post => {
            // Get analytics for this post on the selected page
            const analytics = getPostAnalyticsForPage(post) || {
                impressions: 0,
                reach: 0,
                clicks: 0,
                likes: 0,
                comments: 0,
                shares: 0,
                saves: 0
            };
            
            return {
                ...post,
                analytics: analytics
            };
        });
    }

    function calculateMetrics(posts) {
        const totalPosts = posts.length;
        
        // Use reduce for better performance - single pass through array
        const metrics = posts.reduce((acc, post) => {
            const analytics = post.analytics;
            if (analytics) {
                acc.totalImpressions += analytics.impressions || 0;
                acc.totalReach += analytics.reach || 0;
                const engagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.saves || 0);
                acc.totalEngagement += engagement;
                acc.totalClicks += analytics.clicks || 0;
                acc.totalVideoViews += analytics.video_views || 0;
            }
            return acc;
        }, {
            totalImpressions: 0,
            totalReach: 0,
            totalEngagement: 0,
            totalClicks: 0,
            totalVideoViews: 0
        });

        const avgEngagementPerPost = totalPosts > 0 ? (metrics.totalEngagement / totalPosts).toFixed(0) : 0;

        return {
            totalPosts,
            ...metrics,
            avgEngagementPerPost
        };
    }

    function renderOverview(metrics, posts) {
        // Calculate totals and averages
        let totalReach = 0;
        let totalClicks = 0;
        let totalVideoViews = 0;
        let videoPostCount = 0;
        let totalEngagementRate = 0;
        let postsWithEngagement = 0;

        posts.forEach(post => {
            const analytics = post.analytics;
            if (analytics) {
                totalReach += analytics.reach || 0;
                totalClicks += analytics.clicks || 0;
                
                if (analytics.video_views && analytics.video_views > 0) {
                    totalVideoViews += analytics.video_views;
                    videoPostCount++;
                }
                
                // Calculate engagement rate for this post
                if (analytics.reach > 0) {
                    const engagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.clicks || 0);
                    const rate = (engagement / analytics.reach) * 100;
                    totalEngagementRate += rate;
                    postsWithEngagement++;
                }
            }
        });

        const avgEngagementRate = postsWithEngagement > 0 ? (totalEngagementRate / postsWithEngagement).toFixed(2) : 0;

        // Update summary cards
        document.getElementById('totalReach').textContent = totalReach.toLocaleString();
        document.getElementById('avgEngagement').textContent = avgEngagementRate + '%';
        document.getElementById('totalClicks').textContent = totalClicks.toLocaleString();
        document.getElementById('totalVideoViews').textContent = totalVideoViews.toLocaleString();
        document.getElementById('videoPostsCount').textContent = videoPostCount > 0 ? `${videoPostCount} video post(s)` : 'No video posts';

        // Render charts
        renderEngagementTrendChart(posts);
        renderReachDistributionChart(posts);
        renderTopPerformingPosts(posts);
        
        // Render new page comparison charts
        const pageMetricsData = {{ page_metrics | tojson | safe }} || [];
        const platformMetricsData = {{ platform_metrics | tojson | safe }} || [];
        
        renderPageComparisonChart(pageMetricsData);
        renderPlatformPerformanceChart(platformMetricsData);
        renderPageInsights(pageMetricsData);
        renderRecommendations(pageMetricsData, platformMetricsData);
        
        // Show video performance if we have video posts
        if (videoPostCount > 0) {
            document.getElementById('videoPerformanceSection').style.display = 'block';
            renderVideoPerformanceChart(posts);
        } else {
            document.getElementById('videoPerformanceSection').style.display = 'none';
        }

        // Hide empty state
        document.getElementById('emptyStateOverview').style.display = 'none';
    }

    // Store chart instances to destroy them before recreating
    let chartInstances = {};

    function renderEngagementTrendChart(posts) {
        // Destroy existing chart
        if (chartInstances.engagementTrend) {
            chartInstances.engagementTrend.destroy();
        }

        // Sort posts by date
        const sortedPosts = posts.slice().sort((a, b) => {
            const dateA = new Date(a.scheduled_time || a.sent_time);
            const dateB = new Date(b.scheduled_time || b.sent_time);
            return dateA - dateB;
        });

        // Prepare data
        const labels = sortedPosts.map(post => {
            const date = new Date(post.scheduled_time || post.sent_time);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const engagementRates = sortedPosts.map(post => {
            const analytics = post.analytics;
            if (!analytics || analytics.reach === 0) return 0;
            const engagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.clicks || 0);
            return ((engagement / analytics.reach) * 100).toFixed(2);
        });

        const ctx = document.getElementById('engagementTrendChart').getContext('2d');
        chartInstances.engagementTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Engagement Rate',
                    data: engagementRates,
                    borderColor: '#2c4bff',
                    backgroundColor: 'rgba(44, 75, 255, 0.06)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: '#2c4bff',
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 1.5,
                    pointHoverBackgroundColor: '#2c4bff',
                    pointHoverBorderColor: '#ffffff',
                    pointHoverBorderWidth: 2,
                    borderWidth: 1.5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        titleFont: {
                            size: 12,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '600'
                        },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toFixed(1) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.04)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            },
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }

    function renderReachDistributionChart(posts) {
        // Destroy existing chart
        if (chartInstances.reachDistribution) {
            chartInstances.reachDistribution.destroy();
        }

        // Sort posts by date
        const sortedPosts = posts.slice().sort((a, b) => {
            const dateA = new Date(a.scheduled_time || a.sent_time);
            const dateB = new Date(b.scheduled_time || b.sent_time);
            return dateA - dateB;
        });

        // Prepare data
        const labels = sortedPosts.map(post => {
            const date = new Date(post.scheduled_time || post.sent_time);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const reachData = sortedPosts.map(post => post.analytics.reach || 0);

        const ctx = document.getElementById('reachDistributionChart').getContext('2d');
        chartInstances.reachDistribution = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Reach',
                    data: reachData,
                    backgroundColor: 'rgba(44, 75, 255, 0.75)',
                    borderColor: '#2c4bff',
                    borderWidth: 0,
                    borderRadius: 4,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        titleFont: {
                            size: 12,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '600'
                        },
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString() + ' people';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.04)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            }
                        }
                    }
                }
            }
        });
    }

    function renderTopPerformingPosts(posts) {
        // Calculate engagement rate for each post and sort
        const postsWithRate = posts.map(post => {
            const analytics = post.analytics;
            let engagementRate = 0;
            if (analytics && analytics.reach > 0) {
                const engagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.clicks || 0);
                engagementRate = (engagement / analytics.reach) * 100;
            }
            return {
                ...post,
                engagementRate: engagementRate
            };
        }).sort((a, b) => b.engagementRate - a.engagementRate).slice(0, 5); // Top 5

        if (postsWithRate.length === 0) {
            document.getElementById('topPostsList').innerHTML = '<div style="text-align: center; padding: 40px; color: #9aa0a6; font-size: 13px;">No posts data available</div>';
            return;
        }

        const html = postsWithRate.map((post, index) => {
            const analytics = post.analytics;
            const caption = (post.caption || post.content || 'No caption').replace(/^Posted on\\s+/i, '');
            const displayCaption = caption.length > 80 ? caption.substring(0, 80) + '...' : caption;
            const date = new Date(post.scheduled_time || post.sent_time);
            const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            // Minimalist rank indicators
            const rankNum = index + 1;
            const rankColor = index === 0 ? '#2c4bff' : (index === 1 ? '#10b981' : (index === 2 ? '#f59e0b' : '#9aa0a6'));
            const rankBadge = `<div style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: ${rankColor}; border-radius: 6px; font-size: 12px; font-weight: 700; color: white;">${rankNum}</div>`;

            return `
                <div style="display: flex; align-items: center; gap: 12px; padding: 14px; background: #fafbfc; border: 1px solid #e8eaed; border-radius: 6px; cursor: pointer; transition: all 0.15s;" 
                     onclick="showPostDetail(${post.id})" 
                     onmouseover="this.style.background='#f5f5f5';" 
                     onmouseout="this.style.background='#fafbfc';">
                    ${rankBadge}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 500; color: #1a1a1a; font-size: 13px; margin-bottom: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${displayCaption}</div>
                        <div style="font-size: 11px; color: #9aa0a6;">${dateStr}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 16px; padding-left: 12px; border-left: 1px solid #e8eaed;">
                        <div style="text-align: right;">
                            <div style="font-size: 16px; font-weight: 700; color: #2c4bff; line-height: 1;">${post.engagementRate.toFixed(1)}%</div>
                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px;">Engage</div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; line-height: 1;">${(analytics.reach || 0).toLocaleString()}</div>
                                <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px;">Reach</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; line-height: 1;">${(analytics.likes || 0).toLocaleString()}</div>
                                <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px;">Likes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; font-weight: 600; color: #1a1a1a; line-height: 1;">${(analytics.comments || 0).toLocaleString()}</div>
                                <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 2px;">Comment</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('topPostsList').innerHTML = html;
    }

    function renderVideoPerformanceChart(posts) {
        // Destroy existing chart
        if (chartInstances.videoPerformance) {
            chartInstances.videoPerformance.destroy();
        }

        // Filter posts with video views
        const videoPosts = posts.filter(post => post.analytics.video_views && post.analytics.video_views > 0)
            .sort((a, b) => {
                const dateA = new Date(a.scheduled_time || a.sent_time);
                const dateB = new Date(b.scheduled_time || b.sent_time);
                return dateA - dateB;
            });

        if (videoPosts.length === 0) return;

        // Prepare data
        const labels = videoPosts.map(post => {
            const date = new Date(post.scheduled_time || post.sent_time);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        const videoViews = videoPosts.map(post => post.analytics.video_views);
        const reach = videoPosts.map(post => post.analytics.reach || 0);

        const ctx = document.getElementById('videoPerformanceChart').getContext('2d');
        chartInstances.videoPerformance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Video Views',
                        data: videoViews,
                        backgroundColor: 'rgba(139, 92, 246, 0.75)',
                        borderColor: '#8b5cf6',
                        borderWidth: 0,
                        borderRadius: 4,
                        borderSkipped: false
                    },
                    {
                        label: 'Reach',
                        data: reach,
                        backgroundColor: 'rgba(44, 75, 255, 0.75)',
                        borderColor: '#2c4bff',
                        borderWidth: 0,
                        borderRadius: 4,
                        borderSkipped: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            borderRadius: 3,
                            usePointStyle: false,
                            color: '#5f6368',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: {
                            size: 12,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '600'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.04)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            }
                        }
                    }
                }
            }
        });
    }

    // ===== NEW PAGE COMPARISON CHARTS =====

    function renderPageComparisonChart(pageMetrics) {
        if (chartInstances.pageComparison) {
            chartInstances.pageComparison.destroy();
        }

        if (!pageMetrics || pageMetrics.length === 0) {
            document.getElementById('pageComparisonSection').style.display = 'none';
            return;
        }

        document.getElementById('pageComparisonSection').style.display = 'block';

        // Take top 8 pages to avoid overcrowding
        const topPages = pageMetrics.slice(0, 8);

        const labels = topPages.map(p => p.page_name);
        const engagementData = topPages.map(p => p.avg_engagement_rate);
        const reachData = topPages.map(p => p.avg_reach_per_post);
        const clicksData = topPages.map(p => Math.round(p.total_clicks / Math.max(p.total_posts, 1)));

        const ctx = document.getElementById('pageComparisonChart').getContext('2d');
        chartInstances.pageComparison = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Engagement Rate (%)',
                        data: engagementData,
                        backgroundColor: 'rgba(44, 75, 255, 0.75)',
                        borderRadius: 4,
                        borderSkipped: false,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Avg Reach',
                        data: reachData,
                        backgroundColor: 'rgba(16, 185, 129, 0.75)',
                        borderRadius: 4,
                        borderSkipped: false,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        align: 'end',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            borderRadius: 2,
                            color: '#5f6368',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            padding: 10
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: {
                            size: 12,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '600'
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.04)',
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 10,
                                weight: '500'
                            },
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Engagement Rate (%)',
                            color: '#2c4bff',
                            font: {
                                size: 11,
                                weight: '600'
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#10b981',
                            font: {
                                size: 11,
                                weight: '600'
                            },
                            callback: function(value) {
                                return value.toLocaleString();
                            }
                        },
                        title: {
                            display: true,
                            text: 'Avg Reach',
                            color: '#10b981',
                            font: {
                                size: 11,
                                weight: '600'
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false
                        },
                        ticks: {
                            color: '#9aa0a6',
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        }
                    }
                }
            }
        });
    }

    function renderPlatformPerformanceChart(platformMetrics) {
        if (chartInstances.platformPerformance) {
            chartInstances.platformPerformance.destroy();
        }

        if (!platformMetrics || platformMetrics.length === 0) return;

        const labels = platformMetrics.map(p => {
            const platform = p.platform.charAt(0).toUpperCase() + p.platform.slice(1);
            return `${platform} (${p.page_count} page${p.page_count > 1 ? 's' : ''})`;
        });
        const data = platformMetrics.map(p => p.avg_engagement_rate);

        const platformColors = {
            'facebook': { bg: 'rgba(59, 130, 246, 0.75)', border: '#3b82f6' },
            'instagram': { bg: 'rgba(236, 72, 153, 0.75)', border: '#ec4899' },
            'tiktok': { bg: 'rgba(0, 0, 0, 0.75)', border: '#000000' },
            'linkedin': { bg: 'rgba(14, 118, 168, 0.75)', border: '#0e76a8' },
            'twitter': { bg: 'rgba(29, 155, 240, 0.75)', border: '#1d9bf0' }
        };

        const colors = platformMetrics.map(p => 
            platformColors[p.platform.toLowerCase()] || { bg: 'rgba(107, 114, 128, 0.75)', border: '#6b7280' }
        );

        const ctx = document.getElementById('platformPerformanceChart').getContext('2d');
        chartInstances.platformPerformance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors.map(c => c.bg),
                    borderColor: colors.map(c => c.border),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right',
                        labels: {
                            boxWidth: 10,
                            boxHeight: 10,
                            borderRadius: 3,
                            color: '#5f6368',
                            font: {
                                size: 11,
                                weight: '500'
                            },
                            padding: 10,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                return data.labels.map((label, i) => ({
                                    text: label,
                                    fillStyle: data.datasets[0].backgroundColor[i],
                                    hidden: false,
                                    index: i
                                }));
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1a1a1a',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(0,0,0,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: {
                            size: 12,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13,
                            weight: '600'
                        },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: ${value.toFixed(2)}% engagement`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderPageInsights(pageMetrics) {
        if (!pageMetrics || pageMetrics.length === 0) {
            document.getElementById('pageInsightsList').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #9aa0a6; font-size: 13px;">
                    No page data available
                </div>
            `;
            return;
        }

        const platformIcons = {
            'facebook': 'üìò',
            'instagram': 'üì∑',
            'tiktok': 'üéµ',
            'linkedin': 'üíº',
            'twitter': 'üê¶'
        };

        const html = pageMetrics.slice(0, 6).map((page, index) => {
            const icon = platformIcons[page.platform.toLowerCase()] || 'üì±';
            const rankColor = index === 0 ? '#2c4bff' : (index === 1 ? '#10b981' : (index === 2 ? '#f59e0b' : '#9aa0a6'));
            
            return `
                <div style="background: #fafbfc; padding: 14px; border-radius: 6px; border: 1px solid #e8eaed; transition: all 0.15s ease;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">${icon}</span>
                            <div>
                                <div style="font-size: 13px; font-weight: 600; color: #1a1a1a;">${page.page_name}</div>
                                <div style="font-size: 10px; color: #9aa0a6; text-transform: capitalize;">${page.platform}</div>
                            </div>
                        </div>
                        <div style="background: ${rankColor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700;">
                            #${index + 1}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <div style="font-size: 15px; font-weight: 700; color: #2c4bff;">${page.avg_engagement_rate}%</div>
                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Engage</div>
                        </div>
                        <div>
                            <div style="font-size: 15px; font-weight: 700; color: #1a1a1a;">${page.avg_reach_per_post.toLocaleString()}</div>
                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Reach</div>
                        </div>
                        <div>
                            <div style="font-size: 15px; font-weight: 700; color: #1a1a1a;">${page.total_posts}</div>
                            <div style="font-size: 9px; color: #9aa0a6; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">Posts</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('pageInsightsList').innerHTML = html;
    }

    function renderRecommendations(pageMetrics, platformMetrics) {
        if (!pageMetrics || pageMetrics.length === 0) {
            document.getElementById('recommendationsSection').style.display = 'none';
            return;
        }

        document.getElementById('recommendationsSection').style.display = 'block';

        const recommendations = [];
        
        // Get channel insights for smarter recommendations
        const channelInsights = {{ channel_insights | tojson | safe }} || {};

        // Find best and worst performing pages
        const bestPage = pageMetrics[0];
        const worstPage = pageMetrics[pageMetrics.length - 1];

        // Recommendation 1: Top Performer with actionable insights
        if (bestPage && bestPage.total_posts > 0) {
            const avgReach = Math.round(bestPage.total_reach / bestPage.total_posts);
            recommendations.push({
                icon: 'üåü',
                title: 'Your Top Performer',
                description: `${bestPage.page_name} achieves ${bestPage.avg_engagement_rate}% engagement with ${avgReach.toLocaleString()} average reach. Analyze what makes this content successful and replicate it across other channels.`,
                type: 'success',
                action: 'Study successful patterns'
            });
        }

        // Recommendation 2: Page needs immediate attention
        if (worstPage && worstPage.avg_engagement_rate < 2 && pageMetrics.length > 1 && worstPage.total_posts >= 3) {
            recommendations.push({
                icon: '‚ö†Ô∏è',
                title: 'Underperforming Page',
                description: `${worstPage.page_name} needs attention with ${worstPage.avg_engagement_rate}% engagement. Try: posting during peak hours (6-9 PM), using video content, adding questions to encourage comments, or using trending hashtags.`,
                type: 'warning',
                action: 'Optimize posting strategy'
            });
        }

        // Recommendation 3: Cross-platform insights
        if (platformMetrics && platformMetrics.length > 1) {
            const bestPlatform = platformMetrics.reduce((prev, current) => 
                (prev.avg_engagement_rate > current.avg_engagement_rate) ? prev : current
            );
            const worstPlatform = platformMetrics.reduce((prev, current) => 
                (prev.avg_engagement_rate < current.avg_engagement_rate) ? prev : current
            );
            
            const engagementGap = ((bestPlatform.avg_engagement_rate - worstPlatform.avg_engagement_rate) / worstPlatform.avg_engagement_rate * 100).toFixed(0);
            
            recommendations.push({
                icon: 'üìä',
                title: 'Cross-Platform Opportunity',
                description: `${bestPlatform.platform.charAt(0).toUpperCase() + bestPlatform.platform.slice(1)} performs ${engagementGap}% better than ${worstPlatform.platform}. Consider adapting your successful ${bestPlatform.platform} content format for ${worstPlatform.platform}.`,
                type: 'info',
                action: 'Adapt content across platforms'
            });
        }

        // Recommendation 4: Video content strategy
        const pagesWithVideo = pageMetrics.filter(p => p.posts_with_video > 0);
        const pagesWithoutVideo = pageMetrics.filter(p => p.posts_with_video === 0 && p.total_posts > 2);
        
        if (pagesWithVideo.length > 0 && pagesWithoutVideo.length > 0) {
            const bestVideoPage = pagesWithVideo.reduce((prev, current) => 
                (prev.total_video_views > current.total_video_views) ? prev : current
            );
            
            const videoEngagement = pagesWithVideo.reduce((sum, p) => sum + p.avg_engagement_rate, 0) / pagesWithVideo.length;
            const nonVideoEngagement = pagesWithoutVideo.reduce((sum, p) => sum + p.avg_engagement_rate, 0) / pagesWithoutVideo.length;
            
            if (videoEngagement > nonVideoEngagement * 1.2) {
                recommendations.push({
                    icon: 'üé•',
                    title: 'Video Content Advantage',
                    description: `Video posts get ${((videoEngagement / nonVideoEngagement - 1) * 100).toFixed(0)}% higher engagement! ${bestVideoPage.page_name} has ${bestVideoPage.total_video_views.toLocaleString()} video views. Start creating short-form videos (15-60 seconds) for ${pagesWithoutVideo[0].page_name}.`,
                    type: 'info',
                    action: 'Create more video content'
                });
            }
        } else if (pagesWithVideo.length === 0 && pageMetrics.length > 0) {
            recommendations.push({
                icon: 'üé¨',
                title: 'Video Content Opportunity',
                description: `You haven't posted video content yet. Video posts typically get 48% higher engagement on social media. Start with short, authentic behind-the-scenes clips or quick tips.`,
                type: 'tip',
                action: 'Start with short videos'
            });
        }

        // Recommendation 5: Posting consistency and frequency
        if (pageMetrics.length > 1) {
            const totalPosts = pageMetrics.reduce((sum, p) => sum + p.total_posts, 0);
            const avgPostsPerPage = totalPosts / pageMetrics.length;
            const inconsistentPages = pageMetrics.filter(p => p.total_posts < avgPostsPerPage * 0.5);
            
            if (inconsistentPages.length > 0) {
                const pagesList = inconsistentPages.slice(0, 2).map(p => p.page_name).join(', ');
                recommendations.push({
                    icon: 'üìÖ',
                    title: 'Increase Posting Frequency',
                    description: `${inconsistentPages.length} page(s) including ${pagesList} need more consistent posting. Aim for at least 3-5 posts per week. Regular posting improves algorithm visibility by 30% and keeps your audience engaged.`,
                    type: 'tip',
                    action: 'Schedule more posts'
                });
            }
        }

        // Recommendation 6: Engagement timing insights
        const highPerformers = pageMetrics.filter(p => p.avg_engagement_rate >= 3);
        const lowPerformers = pageMetrics.filter(p => p.avg_engagement_rate < 2 && p.total_posts >= 3);
        
        if (highPerformers.length > 0 && lowPerformers.length > 0) {
            recommendations.push({
                icon: '‚è∞',
                title: 'Optimize Posting Times',
                description: `Your high-performing posts likely share optimal posting times. For most audiences, best times are: Weekdays 6-9 PM, Weekends 9-11 AM. Test different times and track which get immediate engagement.`,
                type: 'tip',
                action: 'Test posting schedules'
            });
        }

        // Recommendation 7: Platform-specific advice
        Object.keys(channelInsights).forEach(platform => {
            const insight = channelInsights[platform];
            const platformName = platform.charAt(0).toUpperCase() + platform.slice(1);
            
            // Facebook-specific insights
            if (platform.toLowerCase() === 'facebook' && insight.avg_engagement_rate < 3 && insight.total_posts >= 5) {
                recommendations.push({
                    icon: 'üìò',
                    title: `Boost ${platformName} Engagement`,
                    description: `Try these proven Facebook strategies: Ask open-ended questions, share user-generated content, use Facebook Live for 3x more engagement, post carousel images (swipe posts), and respond to comments within 1 hour.`,
                    type: 'info',
                    action: 'Try interactive content'
                });
            }
            
            // TikTok-specific insights
            if (platform.toLowerCase() === 'tiktok' && insight.total_posts > 0) {
                const videoPerformance = insight.total_video_views / insight.total_posts;
                if (videoPerformance < 100) {
                    recommendations.push({
                        icon: 'üéµ',
                        title: `Improve ${platformName} Visibility`,
                        description: `Use trending sounds and hashtags, keep videos under 30 seconds, add captions for silent viewing, post 1-3 times daily during peak hours (7-9 PM), and engage with comments immediately to boost algorithm visibility.`,
                        type: 'info',
                        action: 'Leverage TikTok trends'
                    });
                }
            }
        });

        const typeColors = {
            'success': { bg: '#f0fdf4', border: '#10b981', text: '#1a1a1a', iconBg: '#d1fae5' },
            'warning': { bg: '#fef9f3', border: '#f59e0b', text: '#1a1a1a', iconBg: '#fed7aa' },
            'info': { bg: '#f0f9ff', border: '#3b82f6', text: '#1a1a1a', iconBg: '#dbeafe' },
            'tip': { bg: '#faf5ff', border: '#8b5cf6', text: '#1a1a1a', iconBg: '#ede9fe' }
        };

        const html = recommendations.map(rec => {
            const colors = typeColors[rec.type] || typeColors['info'];
            return `
                <div style="background: ${colors.bg}; padding: 16px; border-radius: 8px; border-left: 3px solid ${colors.border}; transition: transform 0.2s ease, box-shadow 0.2s ease;" 
                     onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.08)';" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                    <div style="display: flex; gap: 12px;">
                        <div style="background: ${colors.iconBg}; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                            ${rec.icon}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; font-weight: 700; color: ${colors.text}; margin-bottom: 4px;">${rec.title}</div>
                            <div style="font-size: 12px; color: #5f6368; line-height: 1.5; margin-bottom: 8px;">${rec.description}</div>
                            ${rec.action ? `<div style="font-size: 11px; font-weight: 600; color: ${colors.border}; text-transform: uppercase; letter-spacing: 0.05em;">‚Üí ${rec.action}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('recommendationsList').innerHTML = html;
    }

    function renderOverview_OLD(metrics, posts) {
        const html = `
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Posts</div>
                    <div class="metric-value">${metrics.totalPosts}</div>
                    <div class="metric-change">Posts analyzed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Impressions</div>
                    <div class="metric-value">${metrics.totalImpressions.toLocaleString()}</div>
                    <div class="metric-change">Total views</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Reach</div>
                    <div class="metric-value">${metrics.totalReach.toLocaleString()}</div>
                    <div class="metric-change">Unique people</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Engagement</div>
                    <div class="metric-value">${metrics.totalEngagement}</div>
                    <div class="metric-change">Likes + Comments + Shares + Saves</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Clicks</div>
                    <div class="metric-value">${metrics.totalClicks}</div>
                    <div class="metric-change">Link/Call clicks</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Avg Engagement/Post</div>
                    <div class="metric-value">${metrics.avgEngagementPerPost}</div>
                    <div class="metric-change">Per post average</div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Post Performance Trends</div>
                <p style="color: #999; text-align: center; padding: 40px 0;">Chart integration coming soon with Chart.js library</p>
            </div>
        `;
        document.getElementById('overviewContent').innerHTML = html;
    }

    function renderPostDetails(posts) {
        if (!posts || posts.length === 0) {
            document.getElementById('postsContent').innerHTML = `
                <div class="analyze-empty-state">
                    <div class="analyze-empty-icon">üìù</div>
                    <p class="analyze-empty-text">No posts yet</p>
                    <p class="analyze-empty-subtext">Publish posts to see detailed analytics</p>
                </div>
            `;
            return;
        }

        const html = posts.map(post => {
            // Analytics is already attached to the post from getFilteredPosts()
            const analytics = post.analytics;
            
            const caption = (post.caption || post.content || 'No caption');
            // Remove "Posted on" prefix if it exists
            const cleanCaption = caption.replace(/^Posted on\s+/i, '');
            const displayCaption = cleanCaption.length > 120 ? cleanCaption.substring(0, 120) + '...' : cleanCaption;
            const hasMedia = post.media && post.media.length > 0;
            const mediaPreview = hasMedia ? post.media[0] : null;

            // Media thumbnail HTML
            let thumbnailHTML = '';
            if (mediaPreview && mediaPreview.type === 'image') {
                thumbnailHTML = `<img src="${mediaPreview.url}" alt="Post media" onerror="this.onerror=null; this.parentElement.innerHTML='<svg width=\"40\" height=\"40\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\"><rect x=\"3\" y=\"3\" width=\"18\" height=\"18\" rx=\"2\" ry=\"2\"/><circle cx=\"8.5\" cy=\"8.5\" r=\"1.5\"/><path d=\"M21 15l-5-5L5 21\"/></svg>';">`;
            } else if (mediaPreview && mediaPreview.type === 'video') {
                thumbnailHTML = `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 7l-7 5 7 5V7z"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`;
            } else {
                thumbnailHTML = `<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>`;
            }

            // Channel badges
            const channelBadges = post.pages.map(p => 
                `<span class="post-channel-badge ${p.platform}">${p.page_name}</span>`
            ).join('');

            // Total engagement
            const totalEngagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.saves || 0);

            return `
                <div class="post-list-item" onclick="showPostDetail(${post.id})">
                    <div class="post-thumbnail">
                        ${thumbnailHTML}
                    </div>
                    <div class="post-info">
                        <div class="post-header">
                            <div class="post-caption-text">${displayCaption}</div>
                            <div class="post-date">${formatDate(post.scheduled_time || post.sent_time)}</div>
                        </div>
                        <div class="post-channels">${channelBadges}</div>
                    </div>
                    <div class="post-metrics">
                        <div class="post-metric">
                            <div class="post-metric-value">${analytics.impressions.toLocaleString()}</div>
                            <div class="post-metric-label">Impressions</div>
                        </div>
                        <div class="post-metric">
                            <div class="post-metric-value">${analytics.reach.toLocaleString()}</div>
                            <div class="post-metric-label">Reach</div>
                        </div>
                        <div class="post-metric">
                            <div class="post-metric-value">${totalEngagement.toLocaleString()}</div>
                            <div class="post-metric-label">Engagement</div>
                        </div>
                        <div class="post-metric">
                            <div class="post-metric-value">${analytics.clicks.toLocaleString()}</div>
                            <div class="post-metric-label">Clicks</div>
                        </div>
                    </div>
                    <div class="post-action">
                        <button class="post-view-btn" onclick="event.stopPropagation(); showPostDetail(${post.id});">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }).join('');

        document.getElementById('postsContent').innerHTML = html;
    }

    function showPostDetail(postId) {
        console.log('Opening post detail for post ID:', postId);
        const post = allPosts.find(p => p.id === postId);
        if (!post) {
            console.error('Post not found:', postId);
            return;
        }

        console.log('Post found:', post);
        
        // Get analytics for the selected page (or first page if none selected)
        const pageAnalytics = selectedPage 
            ? post.pages.find(p => p.page_id == selectedPage)
            : (post.pages && post.pages.length > 0 ? post.pages[0] : null);
        
        const analytics = pageAnalytics ? pageAnalytics.analytics : {
            impressions: 0,
            reach: 0,
            clicks: 0,
            likes: 0,
            comments: 0,
            shares: 0,
            saves: 0,
            engagement: 0,
            video_views: 0
        };

        // Set media
        const mediaContainer = document.getElementById('postMediaContainer');
        if (post.media && post.media.length > 0 && post.media[0].type === 'image') {
            mediaContainer.innerHTML = `<img src="${post.media[0].url}" alt="Post media" onerror="this.parentElement.innerHTML='<div class=\\"media-placeholder\\"><svg width=\\"48\\" height=\\"48\\" viewBox=\\"0 0 24 24\\" fill=\\"none\\" stroke=\\"currentColor\\" stroke-width=\\"2\\"><rect x=\\"3\\" y=\\"3\\" width=\\"18\\" height=\\"18\\" rx=\\"2\\" ry=\\"2\\"/><circle cx=\\"8.5\\" cy=\\"8.5\\" r=\\"1.5\\"/><path d=\\"M21 15l-5-5L5 21\\"/></svg></div>';">`;
        } else if (post.media && post.media.length > 0 && post.media[0].type === 'video') {
            mediaContainer.innerHTML = `<video src="${post.media[0].url}" controls style="width:100%;height:100%;object-fit:cover;"></video>`;
        } else {
            mediaContainer.innerHTML = `<div class="media-placeholder"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>`;
        }

        // Set posted date
        document.getElementById('postDetailDate').textContent = formatDate(post.scheduled_time || post.sent_time);
        
        // Set channel badges
        const channelBadges = post.pages.map(p => 
            `<span class="channel-badge ${p.platform}">${p.page_name}</span>`
        ).join('');
        document.getElementById('postDetailPages').innerHTML = channelBadges;

        // Set caption
        document.getElementById('postDetailCaption').textContent = post.caption || post.content || 'No caption';

        // Use stored engagement rate if available, otherwise calculate
        let engagementRate;
        if (analytics.engagement && analytics.engagement > 0) {
            engagementRate = analytics.engagement.toFixed(2);
        } else if (analytics.reach > 0) {
            const totalEngagement = (analytics.likes || 0) + (analytics.comments || 0) + (analytics.shares || 0) + (analytics.clicks || 0);
            engagementRate = ((totalEngagement / analytics.reach) * 100).toFixed(2);
        } else {
            engagementRate = '0.00';
        }

        // Set performance metrics
        document.getElementById('detailImpressions').textContent = (analytics.impressions || 0).toLocaleString();
        document.getElementById('detailReach').textContent = (analytics.reach || 0).toLocaleString();
        document.getElementById('detailClicks').textContent = (analytics.clicks || 0).toLocaleString();
        document.getElementById('detailEngagementRate').textContent = engagementRate + '%';

        // Show video metrics if available
        if (analytics.video_views && analytics.video_views > 0) {
            document.getElementById('detailVideoMetrics').style.display = 'grid';
            document.getElementById('detailVideoViews').textContent = (analytics.video_views || 0).toLocaleString();
        } else {
            document.getElementById('detailVideoMetrics').style.display = 'none';
        }

        // Set engagement breakdown
        document.getElementById('detailLikes').textContent = (analytics.likes || 0).toLocaleString();
        document.getElementById('detailComments').textContent = (analytics.comments || 0).toLocaleString();
        document.getElementById('detailShares').textContent = (analytics.shares || 0).toLocaleString();
        document.getElementById('detailSaves').textContent = (analytics.saves || 0).toLocaleString();

        // Show modal
        console.log('Showing modal...');
        document.getElementById('postDetailModal').classList.add('active');
    }

    function closePostDetail() {
        console.log('Closing modal...');
        document.getElementById('postDetailModal').classList.remove('active');
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        return `${monthNames[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
    }

    // Close modal when clicking outside
    document.getElementById('postDetailModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePostDetail();
        }
    });
    
    // Buffer-style: Load More Posts function
    function loadMorePosts() {
        const currentPage = {{ current_page }};
        const nextPage = currentPage + 1;
        const url = new URL(window.location);
        url.searchParams.set('page', nextPage);
        window.location.href = url.toString();
    }
</script>
{% endblock %}
