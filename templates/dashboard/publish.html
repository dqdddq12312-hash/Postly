{% extends "base.html" %}

{% block body_class %}publish-page{% endblock %}

{% block title %}Publish - Postly Calendar{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/publish.css') }}">
{% endblock %}{% block content %}
<div class="dashboard-container" id="publishDashboardContainer">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <button class="sidebar-collapse-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" aria-label="Collapse sidebar">
            <span id="sidebarToggleIcon">&lt;</span>
        </button>
        <!-- Add Channels Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">Add Channels</div>
            <ul class="channel-list">
                <li class="channel-item">
                    <a href="{{ url_for('connect_social_platform', platform='facebook') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-facebook"></i></span>
                        <span class="channel-label">Facebook</span>
                    </a>
                </li>
                <li class="channel-item">
                    <a href="{{ url_for('publish') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-instagram"></i></span>
                        <span class="channel-label">Instagram</span>
                    </a>
                </li>
                <li class="channel-item">
                    <a href="{{ url_for('connect_social_platform', platform='tiktok') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-tiktok"></i></span>
                        <span class="channel-label">TikTok</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Connected Pages Section -->
        {% if connected_pages %}
        <div class="sidebar-section">
            <div class="sidebar-title">Connected Pages</div>
            {% for platform, pages in pages_by_platform.items() %}
                {% if pages %}
                <div class="platform-group">
                    <div class="platform-group-title" title="{{ platform|capitalize }}">
                        {% if platform == 'facebook' %}
                            <i class="fab fa-facebook"></i>
                            <span class="sr-only">Facebook</span>
                        {% elif platform == 'instagram' %}
                            <i class="fab fa-instagram"></i>
                            <span class="sr-only">Instagram</span>
                        {% elif platform == 'tiktok' %}
                            <i class="fab fa-tiktok"></i>
                            <span class="sr-only">TikTok</span>
                        {% endif %}
                    </div>
                    <ul class="connected-pages">
                        {% for page in pages %}
                        <li class="page-item" onclick="filterByPage({{ page.id }}, '{{ page.page_name }}', '{{ page.platform }}')">
                            <div class="page-item-content">
                                <div class="page-item-avatar">
                                    {% if page.page_profile_pic %}
                                        <img src="{{ page.page_profile_pic }}" alt="{{ page.page_name }} logo" loading="lazy">
                                    {% else %}
                                        <span>{{ page.page_name[:1]|upper if page.page_name else '?' }}</span>
                                    {% endif %}
                                </div>
                                <div class="page-item-info">
                                    <span class="page-item-name">{{ page.page_name }}</span>
                                    {% set import_meta = page._import_meta or {'state': 'idle', 'label': 'History not imported', 'detail': ''} %}
                                    {% set import_state_class = 'success' if import_meta.state == 'completed' else import_meta.state %}
                                    <div class="page-import-meta">
                                        <button type="button"
                                                class="page-import-btn"
                                                data-import-button="{{ page.id }}"
                                                onclick="startPageImport({{ page.id }}, {{ page.page_name|tojson }}, event)"
                                                {% if import_meta.state in ['pending','running'] %}disabled{% endif %}>
                                            {% if import_meta.state in ['pending','running'] %}
                                                <i class="fas fa-spinner fa-spin"></i>
                                                Syncing
                                            {% else %}
                                                <i class="fas fa-history"></i>
                                                Import
                                            {% endif %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button class="page-item-delete-btn" onclick="event.stopPropagation(); deleteConnectedPage({{ page.id }}, '{{ page.page_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not connected_pages %}
        <div class="sidebar-empty-state">
            <div class="sidebar-empty-state-icon">ðŸ“±</div>
            <p class="sidebar-empty-state-text">No connected pages yet. Click a channel above to get started.</p>
        </div>
        {% endif %}
    </div>

        <!-- Main Content Area -->
    <div class="main-content">
        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" id="calendarTab" onclick="switchToCalendarView()">
                <i class="fas fa-calendar"></i> Calendar
            </button>
            <button class="view-tab" id="sheetTab" onclick="switchToSheetView()">
                <i class="fas fa-table"></i> Schedule Sheet
            </button>
        </div>

        <!-- Calendar Header -->
        <div class="calendar-header">
            <div class="calendar-title-section">
                <button class="month-nav-btn" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="monthYearDisplay">November 2025</h2>
                <button class="month-nav-btn" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="pageFilterDisplay" class="page-filter-display" style="display: none;">
                    <span id="filterPageName"></span>
                    <button class="filter-clear-btn" onclick="clearPageFilter()">Ã—</button>
                </div>
            </div>
            <div class="view-controls">
                <a href="{{ url_for('drafts') }}" class="btn btn-outline-primary" title="Review pending draft approvals">
                    <i class="fas fa-file-alt"></i> Drafts
                </a>
                <button class="btn btn-primary" onclick="openCreatePostModal()">
                    <i class="fas fa-plus"></i> New Post
                </button>
            </div>
        </div>

        <!-- Calendar Content -->
        <div class="calendar-content" id="calendarContent">
            <div class="calendar-timeline" id="calendarTimeline">
                <!-- Posts will be rendered here by JavaScript -->
            </div>
        </div>

        <!-- Schedule Sheet Tab -->
        {% include 'dashboard/schedule_sheet.html' %}
    </div>
</div>

<!-- Post Detail Modal -->
<div class="post-detail-modal" id="publishedPostDetailModal">
    <div class="post-detail-modal-content published-post-modal">
        <div class="post-detail-header">
            <div class="post-detail-title-wrap">
                <h2 class="post-detail-title">Published Post</h2>
            </div>
            <button class="post-detail-close" onclick="closePublishedPostDetailModal()">Ã—</button>
        </div>
        
        <div class="post-detail-body">
            <!-- Post Header with Page Info -->
            <div class="published-post-content">
                <div class="published-post-header-info">
                    <div class="published-post-page-info">
                        <i id="publishedPostPageIcon" class="fab fa-facebook"></i>
                        <div>
                            <div class="published-post-page-name" id="publishedPostPageName">Page Name</div>
                            <div class="published-post-time" id="publishedPostTime"></div>
                        </div>
                    </div>
                </div>

                <!-- Post Caption -->
                <div class="published-post-caption" id="publishedPostCaption"></div>

                <!-- Media -->
                <div id="publishedPostMediaSection" style="display: none;">
                    <div id="publishedPostMedia"></div>
                </div>
            </div>
            
            <!-- Metrics -->
            <div class="post-metrics-grid">
                <div class="post-metric" onclick="showMetricDetail('likes', document.getElementById('publishedPostLikes').textContent)">
                    <div class="metric-value" id="publishedPostLikes">-</div>
                    <div class="metric-label">Likes</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('comments', document.getElementById('publishedPostComments').textContent)">
                    <div class="metric-value" id="publishedPostComments">-</div>
                    <div class="metric-label">Comments</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('shares', document.getElementById('publishedPostShares').textContent)">
                    <div class="metric-value" id="publishedPostShares">-</div>
                    <div class="metric-label">Shares</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('impressions', document.getElementById('publishedPostImpressions').textContent)">
                    <div class="metric-value" id="publishedPostImpressions">-</div>
                    <div class="metric-label">Impressions</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('clicks', document.getElementById('publishedPostClicks').textContent)">
                    <div class="metric-value" id="publishedPostClicks">-</div>
                    <div class="metric-label">Clicks</div>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="published-post-actions">
                <a id="publishedPostViewButton" class="post-detail-cta primary" target="_blank" rel="noopener noreferrer" href="#">
                    <i class="fas fa-external-link-alt"></i>
                    View Post
                </a>
                <button type="button" class="post-detail-cta ghost" onclick="closePublishedPostDetailModal()">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detail Metrics Modal -->
<div class="metric-detail-modal" id="metricDetailModal">
    <div class="metric-detail-content">
        <div class="metric-detail-header">
            <h3 id="metricDetailTitle">Metric Detail</h3>
            <button class="post-detail-close" onclick="closeMetricDetailModal()">Ã—</button>
        </div>
        <div class="metric-detail-body">
            <div id="metricDetailContent"></div>
        </div>
    </div>
</div>

<div class="post-detail-modal" id="postDetailModal">
    <div class="post-detail-modal-content">
        <div class="post-detail-header">
            <div class="post-detail-title-wrap">
                <h2 id="postDetailTitle" class="post-detail-title">Scheduled Post</h2>
            </div>
            <button class="post-detail-close" onclick="closePostDetailModal()">Ã—</button>
        </div>
        
        <div class="post-detail-body">
            <!-- Caption Section -->
            <div class="post-detail-section post-detail-section--caption">
                <p id="postDetailCaption" class="post-detail-caption"></p>
            </div>
            
            <!-- Schedule Time Section -->
            <div class="post-detail-section">
                <div class="post-detail-label">Scheduled for</div>
                <div id="postDetailTime" class="post-detail-value"></div>
            </div>
            
            <!-- Status Section -->
            <div class="post-detail-section">
                <div class="post-detail-label">Status</div>
                <span id="postDetailStatus" class="post-status-badge"></span>
            </div>
            
            <!-- Pages Section -->
            <div class="post-detail-section">
                <div class="post-detail-label">Publishing to</div>
                <div id="postDetailPages" class="post-detail-pages"></div>
            </div>
            
            <!-- Media Section -->
            <div class="post-detail-section post-detail-section--media" id="postDetailMediaSection" style="display: none;">
                <div class="post-detail-label">Attached Media</div>
                <div id="postDetailMedia" class="post-detail-media-grid"></div>
            </div>
        </div>
        
        <div class="post-detail-footer post-detail-actions">
            <button type="button" class="post-detail-action-btn ghost" onclick="closePostDetailModal()">
                Close
            </button>
            {% if can_publish_directly %}
            <button type="button" class="post-detail-action-btn success" onclick="publishPostNow()">
                <i class="fas fa-paper-plane"></i>
                Publish
            </button>
            {% endif %}
            <button type="button" class="post-detail-action-btn primary" onclick="editPost()">
                <i class="fas fa-edit"></i>
                Edit
            </button>
            <button id="deletePostBtn" type="button" class="post-detail-action-btn danger" onclick="deletePost()">
                <i class="fas fa-trash"></i>
                Delete
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% include 'dashboard/create_post_modal.html' %}
<script>
    let allPosts = [];
    let currentDate = new Date();
    let filteredPageId = null;
    let filteredPageName = null;
    const currentUserId = {{ current_user_id }};
    let isSidebarCollapsed = false;
    const MAX_POSTS_PER_DAY = 4;
    const pageImportStatus = {{ page_import_status|tojson }};
    const canPublishDirectly = {{ can_publish_directly|tojson }};
    const DEFAULT_IMPORT_META = {
        state: 'idle',
        label: 'History not imported',
        detail: 'Import recent posts to backfill your calendar.',
        posts_imported: 0,
        last_run: null
    };

    // Vietnam timezone offset (UTC+7)
    const VIETNAM_OFFSET = 7 * 60 * 60 * 1000;

    function convertToVietnamTime(utcDate) {
        const date = new Date(utcDate);
        return new Date(date.getTime() + VIETNAM_OFFSET);
    }

    // Format time in HH:MM format (Vietnam timezone)
    function formatTime(dateString) {
        // Use 24-hour format consistently with UTC methods
        const date = convertToVietnamTime(new Date(dateString));
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const mins = String(date.getUTCMinutes()).padStart(2, '0');
        return `${hours}:${mins}`;
    }

    // Format date as YYYY-MM-DD in Vietnam timezone
    function formatDateKey(date) {
        // Convert to Vietnam timezone first, then format
        const vietnamDate = convertToVietnamTime(date);
        const year = vietnamDate.getUTCFullYear();
        const month = String(vietnamDate.getUTCMonth() + 1).padStart(2, '0');
        const day = String(vietnamDate.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Format date and time in Vietnam timezone (24-hour format)
    function formatDateTimeVietnam(utcDateStr) {
        const utcDate = new Date(utcDateStr);
        const vietnamDate = convertToVietnamTime(utcDate);
        
        // Extract components using UTC methods (since we already added 7 hours)
        const year = vietnamDate.getUTCFullYear();
        const month = String(vietnamDate.getUTCMonth() + 1).padStart(2, '0');
        const day = String(vietnamDate.getUTCDate()).padStart(2, '0');
        const hours = String(vietnamDate.getUTCHours()).padStart(2, '0');
        const mins = String(vietnamDate.getUTCMinutes()).padStart(2, '0');
        
        return {
            date: `${day}/${month}/${year}`,
            time: `${hours}:${mins}`,
            dateTime: `${day}/${month}/${year} at ${hours}:${mins}`
        };
    }

    function normalizePostStatus(status) {
        const normalized = (status || 'draft').toLowerCase();
        if (normalized === 'publishing') return 'scheduled';
        if (normalized === 'published') return 'sent';
        return normalized;
    }

    function formatStatusLabel(status) {
        const normalized = (status || 'draft').toLowerCase();
        if (normalized === 'sent' || normalized === 'published') {
            return 'Published';
        }
        if (normalized === 'publishing') {
            return 'Publishing';
        }
        return normalized.charAt(0).toUpperCase() + normalized.slice(1);
    }

    function buildImportMetaFromJob(job) {
        if (!job) {
            return { ...DEFAULT_IMPORT_META };
        }
        const state = (job.status || 'pending').toLowerCase();
        const labelMap = {
            pending: 'Queued for import',
            running: 'Import in progress',
            completed: 'History synced',
            failed: 'Import failed'
        };
        const detailMap = {
            pending: 'We will start pulling posts shortly.',
            running: 'Fetching historical posts in the background.',
            completed: `Imported ${job.posts_imported || 0} post(s).`,
            failed: job.error_message || 'Retry the import to try again.'
        };
        return {
            state,
            label: labelMap[state] || state,
            detail: detailMap[state] || '',
            posts_imported: job.posts_imported,
            last_run: job.finished_at || job.started_at || job.created_at || null
        };
    }

    function resolveImportStateClass(state) {
        if (!state) {
            return 'idle';
        }
        return state === 'completed' ? 'success' : state;
    }

    function updatePageImportUI(pageId, meta) {
        if (!meta) {
            meta = { ...DEFAULT_IMPORT_META };
        }
        pageImportStatus[pageId] = meta;
        const pill = document.querySelector(`[data-import-pill="${pageId}"]`);
        if (pill) {
            pill.textContent = meta.label;
            pill.title = meta.detail || '';
            const cssState = resolveImportStateClass(meta.state);
            pill.className = `page-import-pill state-${cssState}`;
        }
        const button = document.querySelector(`[data-import-button="${pageId}"]`);
        if (button) {
            const isBusy = ['pending', 'running'].includes(meta.state);
            button.disabled = isBusy;
            button.innerHTML = isBusy
                ? '<i class="fas fa-spinner fa-spin"></i> Syncing'
                : '<i class="fa fa-check"></i> Imported';
        }
    }

    function startPageImport(pageId, pageName, event) {
        event?.stopPropagation();
        const button = event?.currentTarget || document.querySelector(`[data-import-button="${pageId}"]`);
        if (button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Syncing';
        }

        fetch(`/api/pages/${pageId}/import-history`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const meta = buildImportMetaFromJob(data.job);
                    updatePageImportUI(pageId, meta);
                    showNotification(`History sync queued for ${pageName}.`, 'success');
                } else {
                    showNotification(data.error || 'Unable to start import', 'error');
                    updatePageImportUI(pageId, pageImportStatus[pageId] || DEFAULT_IMPORT_META);
                }
            })
            .catch(error => {
                console.error('Error starting import:', error);
                showNotification('Unable to start import', 'error');
                updatePageImportUI(pageId, pageImportStatus[pageId] || DEFAULT_IMPORT_META);
            });
    }

    function initializeImportBadges() {
        if (!pageImportStatus) {
            return;
        }
        Object.entries(pageImportStatus).forEach(([pageId, meta]) => {
            updatePageImportUI(pageId, meta || DEFAULT_IMPORT_META);
        });
    }

    // Get platform icon class
    function getPlatformIcon(platform) {
        const icons = {
            'facebook': 'fab fa-facebook',
            'instagram': 'fab fa-instagram',
            'tiktok': 'fab fa-tiktok',
            'twitter': 'fab fa-twitter',
            'linkedin': 'fab fa-linkedin'
        };
        if (!platform) {
            return 'fas fa-share-alt';
        }
        return icons[String(platform).toLowerCase()] || 'fas fa-share-alt';
    }

    // Month navigation
    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    // Page filtering
    function filterByPage(pageId, pageName, platform) {
        filteredPageId = pageId;
        filteredPageName = pageName;
        
        // Show filter display
        const filterDisplay = document.getElementById('pageFilterDisplay');
        if (filterDisplay) {
            document.getElementById('filterPageName').textContent = `${pageName} (${platform})`;
            filterDisplay.style.display = 'block';
        }
        
        renderCalendar();
    }

    function clearPageFilter() {
        filteredPageId = null;
        filteredPageName = null;
        
        // Hide filter display
        const filterDisplay = document.getElementById('pageFilterDisplay');
        if (filterDisplay) {
            filterDisplay.style.display = 'none';
        }
        
        renderCalendar();
    }

    // Delete a connected page
    function deleteConnectedPage(pageId, pageName) {
        if (!confirm(`Are you sure you want to disconnect "${pageName}"? This will delete all posts, analytics, and data associated with this channel. This action cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/connected-pages/${pageId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${pageName} has been disconnected`, 'success');
                // Reload the page to reflect changes
                location.reload();
            } else {
                showNotification(data.error || 'Error disconnecting page', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error disconnecting page', 'error');
        });
    }

    // Get filtered posts
    // Get filtered posts with multi-page expansion
    function getFilteredPosts() {
        let posts = allPosts;
        
        // If page filter is active, filter by page
        if (filteredPageId) {
            posts = posts.filter(post => {
                return post.pages && post.pages.some(p => p.id === filteredPageId);
            });
        }
        
        // Expand posts scheduled for multiple pages into separate calendar entries
        const expandedPosts = [];
        posts.forEach(post => {
            if (post.pages && post.pages.length > 1 && (post.status === 'scheduled' || post.status === 'publishing')) {
                // For scheduled posts with multiple pages, create a separate entry for each page
                post.pages.forEach(page => {
                    expandedPosts.push({
                        ...post,
                        pages: [page], // Single page for calendar display
                        _expandedFromMulti: true, // Mark as expanded
                        _originalId: post.id
                    });
                });
            } else {
                // Regular posts (draft, sent, or single-page scheduled)
                expandedPosts.push(post);
            }
        });
        
        return expandedPosts;
    }

    // Create post badge HTML
    function createPostBadge(post) {
        const dateStr = post.scheduled_time || post.sent_time || post.created_at;
        const time = dateStr ? formatTime(dateStr) : '--:--';
        const normalizedStatus = normalizePostStatus(post.status);

        const pages = Array.isArray(post.pages) ? post.pages : [];
        const platforms = [...new Set(pages.map(p => p.platform).filter(Boolean))].slice(0, 2);
        const platformsHtml = platforms.length
            ? platforms.map(platform => `<i class="${getPlatformIcon(platform)}"></i>`).join('')
            : '<i class="fas fa-share-alt"></i>';
        
        const html = `
            <div class="post-badge ${normalizedStatus}" data-post-id="${post.id}" data-expanded-from="${post._expandedFromMulti ? 'multi' : 'single'}" onclick="showPostDetail(${post._originalId || post.id})">
                <span class="badge-time">${time}</span>
                <span class="badge-dot ${normalizedStatus}"></span>
                <div class="badge-platforms">
                    ${platformsHtml}
                </div>
            </div>
        `;
        return html;
    }

    function createPostBadgeElement(post) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = createPostBadge(post);
        return wrapper.firstElementChild;
    }

    // Render grid calendar
    function renderCalendar() {
        const container = document.getElementById('calendarTimeline');
        if (!container) return;
        
        container.innerHTML = '';
        
        const filteredPosts = getFilteredPosts();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // Update header month/year
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('monthYearDisplay').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        // Get calendar data
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
        const daysInMonth = lastDay.getDate();
        const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
        
        // Group posts by date (include draft, scheduled, and sent posts)
        const postsMap = {};
        filteredPosts.forEach(post => {
            // Show all posts that have a scheduled_time or sent_time
            // This includes drafts with scheduled_time, scheduled posts, and sent posts
            const dateStr = post.scheduled_time || post.sent_time;
            
            // Skip posts without any date
            if (!dateStr) {
                return;
            }
            
            const dateKey = formatDateKey(new Date(dateStr));
            
            if (!postsMap[dateKey]) {
                postsMap[dateKey] = [];
            }
            postsMap[dateKey].push(post);
        });
        
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const headerRow = document.createElement('div');
        headerRow.className = 'calendar-day-headers';
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header-cell';
            header.textContent = day;
            headerRow.appendChild(header);
        });
        container.appendChild(headerRow);
        
        // Create grid
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Create day cells
        let cellCount = 0;
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day-cell';
            
            // Calculate day number
            const dayNum = i - startingDayOfWeek + 1;
            
            if (dayNum < 1 || dayNum > daysInMonth) {
                // Empty cell (previous/next month)
                cell.classList.add('other-month');
            } else {
                // Cell for current month
                const dayDate = new Date(year, month, dayNum);
                const dateKey = formatDateKey(dayDate);
                const postsForDay = (postsMap[dateKey] || []).slice().sort((a, b) => {
                    const dateA = new Date(a.scheduled_time || a.sent_time || a.created_at);
                    const dateB = new Date(b.scheduled_time || b.sent_time || b.created_at);
                    return dateA - dateB;
                });
                const dayStart = new Date(dayDate);
                dayStart.setHours(0, 0, 0, 0);
                if (dayStart.getTime() === today.getTime()) {
                    cell.classList.add('today');
                } else if (dayStart < today) {
                    cell.classList.add('past-day');
                }
                
                // Add day number
                const dayNumberDiv = document.createElement('div');
                dayNumberDiv.className = 'calendar-day-number';
                dayNumberDiv.textContent = dayNum;
                cell.appendChild(dayNumberDiv);
                
                // Add posts container
                const postsContainer = document.createElement('div');
                postsContainer.className = 'calendar-day-posts-grid';
                
                // Filter out duplicates created by multi-page expansion for same day display
                const uniquePostsForDay = [];
                const seenPostIds = new Set();
                postsForDay.forEach(post => {
                    const uniqueKey = post._originalId ? post._originalId : post.id;
                    if (!seenPostIds.has(uniqueKey)) {
                        seenPostIds.add(uniqueKey);
                        uniquePostsForDay.push(post);
                    }
                });
                
                const extraBadges = [];
                uniquePostsForDay.forEach((post, index) => {
                    const badgeEl = createPostBadgeElement(post);
                    if (index >= MAX_POSTS_PER_DAY) {
                        badgeEl.classList.add('extra-post');
                        badgeEl.style.display = 'none';
                        extraBadges.push(badgeEl);
                    }
                    postsContainer.appendChild(badgeEl);
                });
                
                cell.appendChild(postsContainer);
                
                if (extraBadges.length > 0) {
                    const overflowCount = extraBadges.length;
                    const overflowWrapper = document.createElement('div');
                    overflowWrapper.className = 'calendar-day-overflow';

                    const expandBtn = document.createElement('button');
                    expandBtn.type = 'button';
                    expandBtn.className = 'calendar-day-toggle calendar-day-toggle-expand';
                    expandBtn.textContent = `+${overflowCount} more`;
                    expandBtn.setAttribute('aria-expanded', 'false');

                    const collapseBtn = document.createElement('button');
                    collapseBtn.type = 'button';
                    collapseBtn.className = 'calendar-day-toggle calendar-day-toggle-collapse hidden';
                    collapseBtn.textContent = 'Show less';

                    const setExpandedState = (expanded) => {
                        extraBadges.forEach(badge => {
                            badge.style.display = expanded ? 'flex' : 'none';
                        });
                        expandBtn.classList.toggle('hidden', expanded);
                        collapseBtn.classList.toggle('hidden', !expanded);
                        expandBtn.setAttribute('aria-expanded', String(expanded));
                    };

                    expandBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        setExpandedState(true);
                    });

                    collapseBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        setExpandedState(false);
                    });

                    overflowWrapper.appendChild(expandBtn);
                    overflowWrapper.appendChild(collapseBtn);
                    cell.appendChild(overflowWrapper);
                }
            }
            
            grid.appendChild(cell);
            cellCount++;
        }
        
        // Append the entire grid to the container
        container.appendChild(grid);
    }

    // Show post detail modal
    function showPostDetail(postId) {
        // Convert to number for proper comparison
        const post = allPosts.find(p => String(p.id) === String(postId));
        if (!post) {
            console.error('Post not found for ID:', postId);
            return;
        }
        
        const normalizedStatus = normalizePostStatus(post.status);
        
        // Show different modal based on status
        if (normalizedStatus === 'sent') {
            // Published post - show new detailed modal
            showPublishedPostDetail(post);
        } else {
            // Scheduled/draft post - show edit modal
            showScheduledPostDetail(post);
        }
    }

    function showPublishedPostDetail(post) {
        try {
            const dateStr = post.sent_time;
            if (!dateStr) {
                console.error('No sent_time found in post:', post);
                return;
            }
            
            const dateTime = formatDateTimeVietnam(dateStr);
            
            // Page info
            const primaryPage = post.pages && post.pages.length > 0 ? post.pages[0] : null;
            const pageName = primaryPage ? primaryPage.name : 'Unknown Page';
            const platform = primaryPage ? primaryPage.platform : 'facebook';
            
            // Update header with page name and time
            const pageNameEl = document.getElementById('publishedPostPageName');
            const iconEl = document.getElementById('publishedPostPageIcon');
            const timeEl = document.getElementById('publishedPostTime');
            const captionEl = document.getElementById('publishedPostCaption');
            
            if (!pageNameEl || !iconEl || !timeEl || !captionEl) {
                console.error('Modal elements not found');
                return;
            }
            
            pageNameEl.textContent = pageName;
            iconEl.className = getPlatformIcon(platform);
            timeEl.textContent = dateTime.dateTime;
            
            // Populate caption
            captionEl.textContent = post.caption || '';
            
            // Media - render as cards so multiple assets feel distinct
            const mediaSection = document.getElementById('publishedPostMediaSection');
            const mediaContainer = document.getElementById('publishedPostMedia');
            if (post.media && post.media.length > 0) {
                const mediaHtml = post.media.map((mediaItem, index) => {
                    const type = (mediaItem.type || '').toLowerCase();
                    const isImage = type === 'image' || type.startsWith('image');
                    const isVideo = type === 'video' || type.startsWith('video');
                    const badgeIcon = isVideo ? '<i class="fas fa-play"></i>' : '<i class="fas fa-image"></i>';
                    const badgeLabel = isVideo ? 'Video' : 'Image';
                    const content = isImage
                        ? `<img src="${mediaItem.url}" alt="Post media ${index + 1}">`
                        : `<video controls preload="metadata"><source src="${mediaItem.url}" type="video/mp4"></video>`;
                    return `
                        <div class="published-media-card ${isVideo ? 'is-video' : 'is-image'}">
                            <div class="media-type-badge">${badgeIcon}<span>${badgeLabel}</span></div>
                            ${content}
                        </div>
                    `;
                }).join('');
                mediaContainer.innerHTML = mediaHtml;
                mediaContainer.classList.toggle('single-item', post.media.length === 1);
                mediaSection.style.display = 'block';
            } else {
                mediaContainer.innerHTML = '';
                mediaSection.style.display = 'none';
            }
            
            // Fetch real metrics from backend
            fetchPostAnalytics(post.id).then(analytics => {
                document.getElementById('publishedPostLikes').textContent = formatMetricValue(analytics.likes);
                document.getElementById('publishedPostComments').textContent = formatMetricValue(analytics.comments);
                document.getElementById('publishedPostShares').textContent = formatMetricValue(analytics.shares);
                document.getElementById('publishedPostImpressions').textContent = formatMetricValue(analytics.impressions);
                document.getElementById('publishedPostClicks').textContent = formatMetricValue(analytics.clicks);
            }).catch(err => {
                console.error('Error fetching metrics:', err);
                // Show dashes if no analytics
                document.getElementById('publishedPostLikes').textContent = '-';
                document.getElementById('publishedPostComments').textContent = '-';
                document.getElementById('publishedPostShares').textContent = '-';
                document.getElementById('publishedPostImpressions').textContent = '-';
                document.getElementById('publishedPostClicks').textContent = '-';
            });
            
            // View post button - prefer backend-provided permalinks
            const viewButton = document.getElementById('publishedPostViewButton');
            const pages = Array.isArray(post.pages) ? post.pages : [];
            let viewUrl = null;

            // First, try page associations from post.pages if they have view_url
            const pageWithViewUrl = pages.find(p => p.view_url);
            if (pageWithViewUrl && pageWithViewUrl.view_url) {
                viewUrl = pageWithViewUrl.view_url;
            }

            // Fallback to post.view_url if set
            if (!viewUrl && post.view_url) {
                viewUrl = post.view_url;
            }

            // If still no URL, construct from platform_post_id and page info
            if (!viewUrl) {
                // Find page with platform_post_id
                const pageWithPostId = pages.find(p => p.platform_post_id);
                if (pageWithPostId) {
                    viewUrl = getPostUrl({
                        platform: pageWithPostId.platform,
                        platform_post_id: pageWithPostId.platform_post_id,
                        platform_page_id: pageWithPostId.platform_page_id,
                        page_username: pageWithPostId.page_username
                    });
                } else if (post.platform_post_id && primaryPage) {
                    // Last resort: use primary page with post's platform_post_id
                    viewUrl = getPostUrl({
                        platform: primaryPage.platform,
                        platform_post_id: post.platform_post_id,
                        platform_page_id: primaryPage.platform_page_id,
                        page_username: primaryPage.page_username
                    });
                }
            }

            // Set button visibility and href
            if (viewUrl) {
                viewButton.href = viewUrl;
                viewButton.style.display = 'inline-flex';
                viewButton.onclick = function(e) {
                    // Ensure link opens and fires click event
                    if (!e.target.href) {
                        e.preventDefault();
                    }
                };
            } else {
                viewButton.style.display = 'none';
            }
            
            // Show modal
            const modal = document.getElementById('publishedPostDetailModal');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('publishedPostDetailModal not found');
            }
        } catch (error) {
            console.error('Error in showPublishedPostDetail:', error);
        }
    }

    function formatMetricValue(value) {
        if (!value) return '-';
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
        return String(value);
    }

    function showScheduledPostDetail(post) {
        try {
            const dateStr = post.scheduled_time || post.sent_time;
            if (!dateStr) {
                console.error('No date found for post:', post);
                return;
            }
            
            const dateTime = formatDateTimeVietnam(dateStr);
            const rawStatus = post.status || 'draft';
            const statusClass = normalizePostStatus(rawStatus);
            const statusLabel = formatStatusLabel(rawStatus);
            
            const detailModal = document.getElementById('postDetailModal');
            if (!detailModal) {
                console.error('Post detail modal not found');
                return;
            }
            
            // Populate modal with post data
            const caption = post.caption || '';
            const detailTitle = caption ? `${caption.substring(0, 50)}${caption.length > 50 ? '...' : ''}` : 'Scheduled Post';
            document.getElementById('postDetailTitle').textContent = detailTitle;
            document.getElementById('postDetailCaption').textContent = caption;
            document.getElementById('postDetailTime').textContent = dateTime.dateTime;
            document.getElementById('postDetailStatus').textContent = statusLabel;
            document.getElementById('postDetailStatus').className = `post-status-badge ${statusClass}`;
            
            // Show pages with improved styling
            const pages = Array.isArray(post.pages) ? post.pages : [];
            const pagesHtml = pages.map(p => `
                <div class="post-detail-page">
                    <span class="post-detail-page-icon">
                        <i class="${getPlatformIcon(p.platform)}"></i>
                    </span>
                    <div class="post-detail-page-info">
                        <span class="post-detail-page-name">${p.name || 'Connected Page'}</span>
                        <span class="post-detail-page-platform">${p.platform || 'Unknown'}</span>
                    </div>
                </div>
            `).join('');
            document.getElementById('postDetailPages').innerHTML = pagesHtml || '<p class="post-detail-empty">No pages selected</p>';
            
            // Show media with improved styling
            if (post.media && post.media.length > 0) {
                console.log('Displaying media:', post.media);
                const mediaHtml = post.media.map(m => {
                    const isImage = m.type === 'image' || (m.type && m.type.startsWith && m.type.startsWith('image'));
                    const isVideo = m.type === 'video' || (m.type && m.type.startsWith && m.type.startsWith('video'));
                    
                    if (isImage) {
                        return `
                            <div class="post-detail-media-item" onclick="window.open('${m.url}', '_blank')">
                                <img src="${m.url}" alt="Post media" class="post-detail-media-thumb">
                            </div>
                        `;
                    } else if (isVideo) {
                        return `
                            <div class="post-detail-media-item video">
                                <video controls preload="metadata" class="post-detail-media-video">
                                    <source src="${m.url}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>
                            </div>
                        `;
                    }
                    return '';
                }).join('');
                
                if (mediaHtml) {
                    document.getElementById('postDetailMedia').innerHTML = mediaHtml;
                    document.getElementById('postDetailMediaSection').style.display = 'block';
                } else {
                    document.getElementById('postDetailMediaSection').style.display = 'none';
                }
            } else {
                console.log('No media to display');
                document.getElementById('postDetailMediaSection').style.display = 'none';
            }
            
            // Store current post ID for actions (as string for consistency)
            document.getElementById('postDetailModal').dataset.postId = String(post.id);
            
            // Control delete button visibility for scheduled posts
            // Page owners and team members can now delete scheduled posts (server will enforce)
            const deleteBtn = document.getElementById('deletePostBtn');
            if (deleteBtn) {
                // Always show delete button - server will handle authorization
                // This allows page owners and team members to delete scheduled posts
                deleteBtn.style.display = 'flex';
            }
            
            // Show modal
            detailModal.classList.add('active');
        } catch (error) {
            console.error('Error in showScheduledPostDetail:', error);
        }
    }

    // Close published post detail modal
    function closePublishedPostDetailModal() {
        const modal = document.getElementById('publishedPostDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function showMetricDetail(metricType, value) {
        const modal = document.getElementById('metricDetailModal');
        const titleEl = document.getElementById('metricDetailTitle');
        const contentEl = document.getElementById('metricDetailContent');

        // Capitalize first letter for title
        const title = metricType.charAt(0).toUpperCase() + metricType.slice(1);
        titleEl.textContent = title;

        // Create detail content based on metric type
        let detailHTML = '';

        if (metricType === 'likes') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Likes</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Reaction Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Likes represent the number of reactions (Like, Love, Haha, Wow, Sad, Angry) on your post.</p>
            `;
        } else if (metricType === 'comments') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Comments</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Comment Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Comments are conversations that happen on your post.</p>
            `;
        } else if (metricType === 'shares') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Shares</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Share Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Shares measure how many times people shared your post with others.</p>
            `;
        } else if (metricType === 'impressions') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Impressions</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Reach</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Impressions are the number of times your post was displayed in users' feeds.</p>
            `;
        } else if (metricType === 'clicks') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Clicks</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Click-Through Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Clicks include links, hashtags, and other interactive elements on your post.</p>
            `;
        }

        contentEl.innerHTML = detailHTML;

        // Show modal
        if (modal) {
            modal.classList.add('active');
        }
    }

    function closeMetricDetailModal() {
        const modal = document.getElementById('metricDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function getPostUrl(page) {
        if (!page) {
            return null;
        }

        // Return backend-provided URL if available
        if (page.view_url) {
            return page.view_url;
        }

        if (!page.platform_post_id) {
            console.warn('No platform_post_id found for page:', page);
            return null;
        }

        const platform = (page.platform || '').toLowerCase();
        const platformPostId = String(page.platform_post_id).trim();
        const username = (page.page_username || '').trim().replace(/^@/, '');
        const platformPageId = (page.platform_page_id || '').trim();

        if (platform === 'facebook') {
            // Facebook: postid can be "pageId_postId" or just "postId"
            const parts = platformPostId.split('_');
            let postId = platformPostId;
            let pageIdentifier = username || platformPageId;
            
            if (parts.length > 1) {
                // Extract actual post ID (last part)
                postId = parts[parts.length - 1];
                pageIdentifier = pageIdentifier || parts[0]; // Use first part as fallback
            }
            
            if (pageIdentifier && postId) {
                return `https://www.facebook.com/${pageIdentifier}/posts/${postId}`;
            }
            
            // Fallback to direct platform post ID if we can't parse
            return `https://www.facebook.com/photo.php?fbid=${platformPostId}`;
        }

        if (platform === 'instagram') {
            // Instagram URLs use the shortcode (platform_post_id is the media object ID, shortcode is in platform_post_id)
            if (platformPostId && platformPostId.match(/^[A-Za-z0-9_-]+$/)) {
                return `https://www.instagram.com/p/${platformPostId}/`;
            }
            return null;
        }

        if (platform === 'tiktok') {
            const handle = username || platformPageId;
            if (handle && platformPostId) {
                return `https://www.tiktok.com/@${handle}/video/${platformPostId}`;
            }
        }

        return null;
    }

    async function fetchPostAnalytics(postId) {
        try {
            const response = await fetch(`/api/posts/${postId}/analytics`);
            if (response.ok) {
                const data = await response.json();
                return data.analytics || {};
            }
        } catch (e) {
            console.error('Error fetching analytics:', e);
        }
        return {};
    }

    // Close post detail modal
    function closePostDetailModal() {
        const modal = document.getElementById('postDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Edit post
    function editPost() {
        const postId = document.getElementById('postDetailModal').dataset.postId;
        // Convert to number for proper comparison
        const post = allPosts.find(p => String(p.id) === String(postId));
        
        if (!post) {
            console.error('Post not found for ID:', postId);
            console.log('Available posts:', allPosts.map(p => ({id: p.id, caption: p.caption.substring(0, 30)})));
            alert('Error: Post not found. Please refresh the page and try again.');
            return;
        }
        
        console.log('Opening edit modal for post:', post.id);
        // Open create post modal in edit mode
        openCreatePostModal('edit', post);
        closePostDetailModal();
    }

    // Delete post
    function deletePost() {
        const postId = document.getElementById('postDetailModal').dataset.postId;
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        console.log('Deleting post:', postId);
        fetch(`/api/posts/${postId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closePostDetailModal();
                    loadPostsOnCalendar();
                    showNotification('Post deleted successfully', 'success');
                } else {
                    showNotification(data.error || 'Error deleting post', 'error');
                }
            })
            .catch(err => {
                console.error('Error deleting post:', err);
                showNotification('Error deleting post', 'error');
            });
    }

    // Publish post now
    function publishPostNow() {
        if (!canPublishDirectly) {
            showNotification('Publishing is disabled for your role.', 'error');
            return;
        }
        const postId = document.getElementById('postDetailModal').dataset.postId;
        const publishBtn = document.querySelector('#postDetailModal button[onclick="publishPostNow()"]');
        
        // Prevent multiple simultaneous publishes
        if (publishBtn.disabled) {
            console.log('[PUBLISH_NOW] Already publishing, ignoring duplicate click');
            return;
        }
        
        // Disable button
        publishBtn.disabled = true;
        const originalBtnHtml = publishBtn.innerHTML;
        publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
        publishBtn.style.opacity = '0.6';
        publishBtn.style.cursor = 'not-allowed';
        
        console.log('Publishing post now:', postId);
        fetch(`/api/posts/${postId}/publish`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closePostDetailModal();
                    loadPostsOnCalendar();
                    showNotification('Post published successfully', 'success');
                } else {
                    showNotification(data.error || 'Error publishing post', 'error');
                    // Re-enable button on error
                    publishBtn.disabled = false;
                    publishBtn.innerHTML = originalBtnHtml;
                    publishBtn.style.opacity = '1';
                    publishBtn.style.cursor = 'pointer';
                }
            })
            .catch(err => {
                console.error('Error publishing post:', err);
                showNotification('Error publishing post', 'error');
                // Re-enable button on error
                publishBtn.disabled = false;
                publishBtn.innerHTML = originalBtnHtml;
                publishBtn.style.opacity = '1';
                publishBtn.style.cursor = 'pointer';
            });
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Tab Switching Functions
    function switchToCalendarView() {
        document.getElementById('calendarTab').classList.add('active');
        document.getElementById('sheetTab').classList.remove('active');
        document.getElementById('calendarContent').style.display = 'block';
        document.getElementById('scheduleSheetContainer').style.display = 'none';
        document.querySelector('.calendar-header').style.display = 'flex';
        
        // Re-render the calendar to ensure it displays correctly
        renderCalendar();
    }

    function switchToSheetView() {
        document.getElementById('sheetTab').classList.add('active');
        document.getElementById('calendarTab').classList.remove('active');
        document.getElementById('calendarContent').style.display = 'none';
        document.querySelector('.calendar-header').style.display = 'none';
        document.getElementById('scheduleSheetContainer').style.display = 'flex';
        
        // Initialize sheet if not already done
        if (typeof initializeSheetTab === 'function') {
            initializeSheetTab();
        }
    }

    function applySidebarCollapsedState(collapsed) {
        const container = document.getElementById('publishDashboardContainer');
        if (!container) return;
        isSidebarCollapsed = collapsed;
        container.classList.toggle('sidebar-collapsed', collapsed);
        const icon = document.getElementById('sidebarToggleIcon');
        if (icon) {
            icon.textContent = collapsed ? '>' : '<';
        }
        try {
            localStorage.setItem('publishSidebarCollapsed', collapsed ? '1' : '0');
        } catch (error) {
            console.warn('Unable to persist sidebar preference:', error);
        }
    }

    function toggleSidebar() {
        applySidebarCollapsedState(!isSidebarCollapsed);
    }

    function initializeSidebarToggle() {
        let savedState = '0';
        try {
            savedState = localStorage.getItem('publishSidebarCollapsed') || '0';
        } catch (error) {
            console.warn('Unable to read sidebar preference:', error);
        }
        applySidebarCollapsedState(savedState === '1');
    }

    // Fetch posts and display them on calendar
    function loadPostsOnCalendar() {
        fetch('/api/posts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allPosts = data.posts;
                    renderCalendar();
                }
            })
            .catch(error => {
                console.error('Error loading posts:', error);
                showNotification('Error loading posts', 'error');
            });
    }

    // Load posts on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeSidebarToggle();
        initializeImportBadges();
        loadPostsOnCalendar();
    });
</script>

<style>
    .post-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background-color: #f0f7ff;
        border: 1px solid #007bff;
        border-radius: 12px;
        padding: 4px 8px;
        margin-top: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .post-badge:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }

    .badge-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #28a745;
    }

    .badge-dot.scheduled {
        background-color: #ffc107;
    }

    .badge-dot.sent {
        background-color: #28a745;
    }

    .badge-text {
        font-weight: 500;
        white-space: nowrap;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-scheduled {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-sent {
        background-color: #d4edda;
        color: #155724;
    }

    /* Enhanced Calendar Day Styling */
    .calendar-day {
        display: flex;
        gap: 0;
        min-height: 200px;
        margin-bottom: 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .calendar-day-header {
        width: 100px;
        padding: 16px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .day-name {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
    }

    .day-date {
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }

    .calendar-day-posts {
        flex: 1;
        display: flex;
        gap: 12px;
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
        align-items: flex-start;
    }

    .calendar-day-posts::-webkit-scrollbar {
        height: 6px;
    }

    .calendar-day-posts::-webkit-scrollbar-track {
        background: #f0f0f0;
    }

    .calendar-day-posts::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .calendar-day-posts::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    .empty-posts {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ccc;
        font-size: 14px;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Post Card */
    .post-card {
        flex-shrink: 0;
        width: 300px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        border-color: #667eea;
        transform: translateY(-2px);
    }

    .post-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #f0f0f0;
    }

    .post-time {
        font-size: 12px;
        font-weight: 600;
        color: #667eea;
    }

    .post-card-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .post-card-status.scheduled {
        background-color: #fff3cd;
        color: #856404;
    }

    .post-card-status.sent {
        background-color: #d4edda;
        color: #155724;
    }

    .post-card-body {
        flex: 1;
    }

    .post-card-caption {
        font-size: 13px;
        line-height: 1.4;
        color: #333;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-wrap: break-word;
    }

    .post-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 6px;
        border-top: 1px solid #f0f0f0;
        font-size: 12px;
    }

    .post-platforms {
        display: flex;
        gap: 6px;
    }

    .post-platforms i {
        font-size: 14px;
        color: #667eea;
    }

    .post-media-count {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #999;
    }

    .post-media-count i {
        font-size: 12px;
    }

    /* Post Detail Modal */
    .post-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    .post-detail-modal.active {
        display: flex;
    }

    .post-detail-modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .post-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
        background: #ffffff;
        color: #050505;
        border-radius: 12px 12px 0 0;
    }

    .post-detail-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #050505;
    }

    .post-detail-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .post-detail-close:hover {
        background: #f5f5f5;
        color: #050505;
    }

    .post-detail-body {
        flex: 1;
        padding: 16px 20px;
        overflow-y: auto;
    }

    .post-detail-section {
        margin-bottom: 16px;
    }

    .post-detail-section:last-child {
        margin-bottom: 0;
    }

    .post-detail-section h4 {
        margin: 0 0 8px 0;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #65676b;
        letter-spacing: 0.3px;
    }

    .post-detail-section p {
        margin: 0;
        font-size: 13px;
        line-height: 1.5;
        color: #050505;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .post-status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .post-status-badge.scheduled {
        background-color: #fff5e6;
        color: #cc8800;
    }

    .post-status-badge.sent {
        background-color: #e8f5e9;
        color: #2e7d32;
    }

    .post-status-badge.draft {
        background-color: #f5f5f5;
        color: #666;
    }

    #postDetailPages {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .post-page-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #333;
    }

    .post-page-item i {
        font-size: 16px;
        color: #667eea;
        width: 20px;
        text-align: center;
    }

    #postDetailMedia {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
    }
    
    #postDetailMedia img,
    #postDetailMedia video {
        transition: transform 0.2s ease;
    }
    
    #postDetailMedia > div {
        aspect-ratio: 1;
        min-height: 120px;
    }

    .post-detail-media {
        border-radius: 6px;
        overflow: hidden;
        background: #f0f0f0;
        aspect-ratio: 1;
    }

    .post-detail-media img,
    .post-detail-media video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .post-detail-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 12px 20px;
        border-top: 1px solid #ede8e8;
        background: #fafafa;
        border-radius: 0 0 12px 12px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary {
        background-color: #e7e7e7;
        color: #333;
    }

    .btn-secondary:hover {
        background-color: #d0d0d0;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    /* Published Post Modal */
    .published-post-modal {
        max-width: 650px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12) !important;
    }

    .published-post-modal .post-detail-header {
        background: #ffffff;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
    }

    .published-post-modal .post-detail-header h2 {
        font-size: 16px;
        font-weight: 600;
        color: #ffffff;
        margin: 0;
    }

    .published-post-modal .post-detail-body {
        background: #ffffff;
        padding: 0;
    }

    /* Published post content container */
    .published-post-content {
        padding: 12px 0;
        border-bottom: 1px solid #ede8e8;
    }

    .published-post-header-info {
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .published-post-page-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .published-post-page-info i {
        font-size: 14px;
        color: #999;
    }

    .published-post-page-name {
        font-size: 12px;
        font-weight: 600;
        color: #050505;
    }

    .published-post-time {
        font-size: 11px;
        color: #65676b;
    }

    .published-post-caption {
        padding: 0 16px;
        margin-bottom: 8px;
        font-size: 13px;
        line-height: 1.5;
        color: #050505;
        word-wrap: break-word;
        white-space: pre-wrap;
    }

    #publishedPostMediaSection {
        padding: 0 16px;
        margin-bottom: 8px;
    }

    #publishedPostMedia {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 10px;
    }

    #publishedPostMedia.single-item {
        grid-template-columns: 1fr;
    }

    .published-media-card {
        position: relative;
        border-radius: 10px;
        overflow: hidden;
        background: #0f1419;
        min-height: 140px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    .published-media-card img,
    .published-media-card video {
        width: 100%;
        height: 100%;
        display: block;
        object-fit: cover;
        background: #000;
    }

    .published-media-card video {
        background: #000;
    }

    .media-type-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 600;
        color: white;
        background: rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(6px);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .media-type-badge i {
        font-size: 10px;
    }

    /* Metrics Grid - Facebook Style */
    .post-metrics-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1px;
        padding: 1px;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        margin: 16px 0;
        background: #e5e5e5;
        border-radius: 8px;
        overflow: hidden;
    }

    .post-metric {
        text-align: center;
        padding: 16px 8px;
        background: #ffffff;
        border-radius: 0;
        transition: all 0.15s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }

    .post-metric:hover {
        background: #f8f9fa;
    }

    .metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #050505;
        margin-bottom: 4px;
        line-height: 1;
    }

    .metric-label {
        font-size: 11px;
        color: #65676b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        line-height: 1.2;
    }

    /* Action buttons */
    .published-post-actions {
        display: flex;
        gap: 8px;
        padding: 12px 0;
        margin-top: 12px;
        border-top: 1px solid #ede8e8;
        justify-content: space-between;
    }

    .published-post-actions.button {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid #e4e6eb;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        background: #e4e6eb;
        color: #050505;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .published-post-actions.button:hover {
        background: #d0d2d7;
        border-color: #bcc0c4;
    }

    .published-post-actions.button i {
        margin-right: 6px;
    }

    /* Detail metrics modal */
    .metric-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    .metric-detail-modal.active {
        display: flex;
    }

    .metric-detail-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 70vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    .metric-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
        background: #ffffff;
        border-radius: 12px 12px 0 0;
    }

    .metric-detail-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #050505;
    }

    .metric-detail-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .metric-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .metric-detail-item:last-child {
        border-bottom: none;
    }

    .metric-detail-label {
        font-size: 13px;
        color: #65676b;
        font-weight: 500;
    }

    .metric-detail-value {
        font-size: 16px;
        font-weight: 700;
        color: #050505;
    }
    .published-post-actions {
        padding: 12px 16px;
        display: flex;
        gap: 8px;
    }

    .published-post-actions button {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    #publishedPostViewButton {
        background: #1877f2;
        color: white;
    }

    #publishedPostViewButton:hover {
        background: #0a66c2;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(24, 119, 242, 0.3);
    }

    /* Notification Toast */
    .notification {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        transition: bottom 0.3s ease;
        max-width: 400px;
    }

    .notification.show {
        bottom: 30px;
    }

    .notification-success {
        border-left: 4px solid #28a745;
        color: #155724;
    }

    .notification-success i {
        color: #28a745;
    }

    .notification-error {
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    .notification-error i {
        color: #dc3545;
    }

    .notification-info {
        border-left: 4px solid #17a2b8;
        color: #0c5460;
    }

    .notification-info i {
        color: #17a2b8;
    }
</style>
{% endblock %}
