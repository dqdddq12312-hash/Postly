{% extends "base.html" %}

{% block title %}Publish - Postly Calendar{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        display: flex;
        height: calc(100vh - 100px);
        background-color: #f8f9fa;
    }

    .sidebar {
        width: 280px;
        background: #ffffff;
        border-right: 1px solid #ede8e8;
        overflow-y: auto;
        padding: 16px;
        box-shadow: none;
    }

    .sidebar-section {
        margin-bottom: 24px;
    }

    .sidebar-title {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        color: #65676b;
        margin-bottom: 12px;
        letter-spacing: 0.3px;
    }

    .channel-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .channel-item {
        margin-bottom: 10px;
    }

    .channel-btn {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ccc;
        background-color: white;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: left;
        color: #050505;
        font-weight: 500;
    }

    .channel-btn:hover {
        background-color: #f0f2f5;
        border-color: #999;
    }

    .channel-btn.connected {
        background: #f0f2f5;
        border-color: #999;
        color: #050505;
    }

    .channel-icon {
        margin-right: 8px;
        font-size: 16px;
    }

    .connected-pages {
        list-style: none;
        padding: 0;
        margin: 15px 0 0 0;
    }

    .connected-pages-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #999;
        margin-bottom: 8px;
    }

    .page-item {
        padding: 8px 10px;
        background-color: #f5f5f5;
        border-left: 3px solid #999;
        border-radius: 4px;
        margin-bottom: 6px;
        font-size: 12px;
        color: #050505;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .page-item:hover {
        background-color: #efefef;
        border-left-color: #666;
        box-shadow: none;
    }

    .page-item-name {
        font-weight: 500;
        display: block;
        color: #050505;
    }

    .page-item-platform {
        font-size: 10px;
        color: #999;
        font-weight: 400;
    }

    .page-item-delete-btn {
        background: none;
        border: none;
        color: #999;
        cursor: pointer;
        font-size: 12px;
        padding: 4px 6px;
        border-radius: 4px;
        transition: all 0.2s;
        display: none;
    }

    .page-item:hover .page-item-delete-btn {
        display: inline-block;
        color: #dc3545;
        background-color: rgba(220, 53, 69, 0.1);
    }

    .page-item-delete-btn:hover {
        background-color: rgba(220, 53, 69, 0.2);
        color: #c82333;
    }

    /* View Tabs */
    .view-tabs {
        display: flex;
        gap: 0;
        background: white;
        border-bottom: 1px solid #ede8e8;
        padding: 0 16px;
    }

    .view-tab {
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: #65676b;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 2px solid transparent;
    }

    .view-tab:hover {
        color: #050505;
    }

    .view-tab.active {
        color: #1877f2;
        border-bottom-color: #1877f2;
    }

    /* Calendar Header Updates */
    .calendar-title-section {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .month-nav-btn {
        background-color: white;
        border: 1px solid #ccc;
        color: #050505;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
    }

    .month-nav-btn:hover {
        background-color: #f5f5f5;
        border-color: #999;
    }

    .page-filter-display {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: #f5f5f5;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        color: #050505;
        font-weight: 500;
        border: 1px solid #ccc;
    }

    .filter-clear-btn {
        background: none;
        border: none;
        color: #999;
        font-size: 14px;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .filter-clear-btn:hover {
        background-color: #efefef;
        color: #050505;
    }

    /* Grid Calendar Styles */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0;
        background-color: #e8ebed;
        border: 1px solid #d0d0d0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        margin: 0 8px 8px 8px;
    }

    .calendar-day-header-grid {
        display: contents;
    }

    .calendar-day-header-cell {
        padding: 12px 8px;
        text-align: center;
        font-weight: 700;
        font-size: 12px;
        color: #1877f2;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background-color: #f8f9fa;
        border-bottom: 2px solid #e0e0e0;
    }

    .calendar-day-cell {
        background-color: white;
        min-height: 110px;
        padding: 10px;
        position: relative;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #e8ebed;
        border-bottom: 1px solid #e8ebed;
        transition: background-color 0.2s;
    }

    .calendar-day-cell:hover {
        background-color: #f8f9fa;
    }

    .calendar-day-cell.other-month {
        background-color: #f5f6f7;
        color: #bbb;
    }

    .calendar-day-number {
        font-weight: 600;
        font-size: 14px;
        color: #050505;
        margin-bottom: 6px;
    }

    .calendar-day-cell.other-month .calendar-day-number {
        color: #ccc;
    }

    .calendar-day-posts-grid {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
    }

    .post-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
        overflow: hidden;
    }

    .post-badge:hover {
        background-color: #f5f5f5;
        border-color: #999;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .post-badge.scheduled {
        border-left: 3px solid #ffa500;
        background: linear-gradient(to right, rgba(255, 165, 0, 0.05), white);
    }

    .post-badge.sent {
        border-left: 3px solid #31a24c;
        background: linear-gradient(to right, rgba(49, 162, 76, 0.05), white);
    }

    .post-badge.draft {
        border-left: 3px solid #999;
        background: linear-gradient(to right, rgba(153, 153, 153, 0.05), white);
    }

    .badge-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #999;
        flex-shrink: 0;
    }

    .badge-dot.scheduled {
        background-color: #ffa500;
    }

    .badge-dot.sent {
        background-color: #31a24c;
    }

    .badge-dot.draft {
        background-color: #999;
    }

    .badge-text {
        font-weight: 500;
        white-space: nowrap;
        color: #333;
    }

    .post-badge i {
        font-size: 10px;
        color: #1877f2;
    }

    /* Calendar Styles - Facebook Professional */
    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f0f2f5;
        margin: 0;
        overflow: hidden;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        background-color: white;
        border-bottom: 1px solid #ede8e8;
        box-shadow: none;
        margin: 8px 8px 0 8px;
    }

    .calendar-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 700;
        color: #050505;
        letter-spacing: -0.2px;
    }

    .view-controls {
        display: flex;
        gap: 12px;
    }

    .view-btn:hover {
        background: #f5f5f5;
    }

    .view-btn.active {
        background: #f0f2f5;
        color: #050505;
    }

    .btn-primary {
        padding: 8px 16px;
        background: #1877f2;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
    }

    .btn-primary:hover {
        background: #0a66c2;
    }

    /* Calendar Content Area */
    .calendar-content {
        flex: 1;
        display: flex;
        overflow: hidden;
        padding: 16px;
        background-color: #f0f2f5;
    }

    .calendar-timeline {
        flex: 1;
        width: 100%;
    }
        border-right: 1px solid #e0e0e0;
        flex-shrink: 0;
        position: sticky;
        left: 0;
        z-index: 2;
    }

    .page-item-platform {
        font-size: 11px;
        color: #999;
        margin-top: 2px;
    }

    .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f0f2f5;
        margin: 16px;
        overflow: hidden;
    }

    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        color: #999;
    }

    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 20px;
        color: #ddd;
    }

    .empty-state-text {
        font-size: 16px;
        margin-bottom: 10px;
        font-weight: 500;
    }

    .time-slots {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .time-slot {
        font-size: 12px;
        padding: 10px;
        background-color: #f9f9f9;
        border-radius: 4px;
        border-left: 3px solid #28a745;
    }

    .month-view .day-cell {
        min-height: 100px;
    }

    .week-view .day-cell {
        min-height: 300px;
    }

    @media (max-width: 1024px) {
        .sidebar {
            width: 200px;
        }

        .main-content {
            padding: 15px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <!-- Add Channels Section -->
        <div class="sidebar-section">
            <div class="sidebar-title">Add Channels</div>
            <ul class="channel-list">
                <li class="channel-item">
                    <a href="{{ url_for('connect_social_platform', platform='facebook') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-facebook"></i></span>
                        <span>Facebook</span>
                    </a>
                </li>
                <li class="channel-item">
                    <a href="{{ url_for('connect_social_platform', platform='instagram') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-instagram"></i></span>
                        <span>Instagram</span>
                    </a>
                </li>
                <li class="channel-item">
                    <a href="{{ url_for('connect_social_platform', platform='tiktok') }}" class="channel-btn">
                        <span class="channel-icon"><i class="fab fa-tiktok"></i></span>
                        <span>TikTok</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Connected Pages Section -->
        {% if connected_pages %}
        <div class="sidebar-section">
            <div class="sidebar-title">Connected Pages</div>
            {% for platform, pages in pages_by_platform.items() %}
                {% if pages %}
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 8px;">
                        {% if platform == 'facebook' %}
                            <i class="fab fa-facebook" style="color: #1877f2;"></i> Facebook
                        {% elif platform == 'instagram' %}
                            <i class="fab fa-instagram" style="background: linear-gradient(45deg, #f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i> Instagram
                        {% elif platform == 'tiktok' %}
                            <i class="fab fa-tiktok" style="color: #000;"></i> TikTok
                        {% endif %}
                    </div>
                    <ul class="connected-pages">
                        {% for page in pages %}
                        <li class="page-item" onclick="filterByPage({{ page.id }}, '{{ page.page_name }}', '{{ page.platform }}')">
                            <div style="flex: 1;">
                                <span class="page-item-name">{{ page.page_name }}</span>
                                <span class="page-item-platform">{{ page.platform_page_id }}</span>
                            </div>
                            <button class="page-item-delete-btn" onclick="event.stopPropagation(); deleteConnectedPage({{ page.id }}, '{{ page.page_name }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Empty State -->
        {% if not connected_pages %}
        <div class="sidebar-section" style="background-color: #f9f9f9; padding: 15px; border-radius: 6px;">
            <div style="font-size: 12px; color: #999; text-align: center;">
                <div style="font-size: 20px; margin-bottom: 8px;">ðŸ“±</div>
                <p style="margin: 0;">No connected pages yet. Click a channel above to get started.</p>
            </div>
        </div>
        {% endif %}
    </div>

        <!-- Main Content Area -->
    <div class="main-content">
        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="view-tab active" id="calendarTab" onclick="switchToCalendarView()">
                <i class="fas fa-calendar"></i> Calendar
            </button>
            <button class="view-tab" id="sheetTab" onclick="switchToSheetView()">
                <i class="fas fa-table"></i> Schedule Sheet
            </button>
        </div>

        <!-- Calendar Header -->
        <div class="calendar-header">
            <div class="calendar-title-section">
                <button class="month-nav-btn" onclick="previousMonth()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="monthYearDisplay">November 2025</h2>
                <button class="month-nav-btn" onclick="nextMonth()">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div id="pageFilterDisplay" class="page-filter-display" style="display: none;">
                    <span id="filterPageName"></span>
                    <button class="filter-clear-btn" onclick="clearPageFilter()">Ã—</button>
                </div>
            </div>
            <div class="view-controls">
                <button class="btn btn-primary" onclick="refreshHistoricalPosts()" title="Fetch historical posts from connected pages">
                    <i class="fas fa-sync-alt"></i> Refresh History
                </button>
                <a href="{{ url_for('drafts') }}" class="btn btn-outline-primary" title="Review pending draft approvals">
                    <i class="fas fa-file-alt"></i> Draft Approvals
                </a>
                <button class="btn btn-primary" onclick="openCreatePostModal()">
                    <i class="fas fa-plus"></i> New Post
                </button>
            </div>
        </div>

        <!-- Calendar Content -->
        <div class="calendar-content" id="calendarContent">
            <div class="calendar-timeline" id="calendarTimeline">
                <!-- Posts will be rendered here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Schedule Sheet Tab -->
    {% include 'dashboard/schedule_sheet.html' %}
</div>

<!-- Post Detail Modal -->
<div class="post-detail-modal" id="publishedPostDetailModal">
    <div class="post-detail-modal-content published-post-modal">
        <div class="post-detail-header">
            <div style="flex: 1;">
                <h2 style="margin: 0; color: #050505; font-size: 16px; font-weight: 600;">Published Post</h2>
            </div>
            <button class="post-detail-close" onclick="closePublishedPostDetailModal()">Ã—</button>
        </div>
        
        <div class="post-detail-body">
            <!-- Post Header with Page Info -->
            <div class="published-post-content">
                <div class="published-post-header-info">
                    <div class="published-post-page-info">
                        <i id="publishedPostPageIcon" class="fab fa-facebook"></i>
                        <div>
                            <div class="published-post-page-name" id="publishedPostPageName">Page Name</div>
                            <div class="published-post-time" id="publishedPostTime"></div>
                        </div>
                    </div>
                </div>

                <!-- Post Caption -->
                <div class="published-post-caption" id="publishedPostCaption"></div>

                <!-- Media -->
                <div id="publishedPostMediaSection" style="display: none;">
                    <div id="publishedPostMedia"></div>
                </div>
            </div>
            
            <!-- Metrics -->
            <div class="post-metrics-grid">
                <div class="post-metric" onclick="showMetricDetail('likes', document.getElementById('publishedPostLikes').textContent)">
                    <div class="metric-value" id="publishedPostLikes">-</div>
                    <div class="metric-label">Likes</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('comments', document.getElementById('publishedPostComments').textContent)">
                    <div class="metric-value" id="publishedPostComments">-</div>
                    <div class="metric-label">Comments</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('shares', document.getElementById('publishedPostShares').textContent)">
                    <div class="metric-value" id="publishedPostShares">-</div>
                    <div class="metric-label">Shares</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('impressions', document.getElementById('publishedPostImpressions').textContent)">
                    <div class="metric-value" id="publishedPostImpressions">-</div>
                    <div class="metric-label">Impressions</div>
                </div>
                <div class="post-metric" onclick="showMetricDetail('clicks', document.getElementById('publishedPostClicks').textContent)">
                    <div class="metric-value" id="publishedPostClicks">-</div>
                    <div class="metric-label">Clicks</div>
                </div>
            </div>

            <!-- Action buttons -->
            <div class="published-post-actions">
                <a id="publishedPostViewButton" class="published-post-actions button" target="_blank" href="#" style="text-decoration: none;">
                    <i class="fas fa-external-link-alt"></i>View Post
                </a>
                <button onclick="closePublishedPostDetailModal()" style="flex: 1; padding: 10px 16px; border: 1px solid #e4e6eb; border-radius: 6px; font-size: 13px; font-weight: 600; background: white; color: #050505; cursor: pointer; transition: all 0.2s;">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Detail Metrics Modal -->
<div class="metric-detail-modal" id="metricDetailModal">
    <div class="metric-detail-content">
        <div class="metric-detail-header">
            <h3 id="metricDetailTitle">Metric Detail</h3>
            <button class="post-detail-close" onclick="closeMetricDetailModal()">Ã—</button>
        </div>
        <div class="metric-detail-body">
            <div id="metricDetailContent"></div>
        </div>
    </div>
</div>

<div class="post-detail-modal" id="postDetailModal">
    <div class="post-detail-modal-content">
        <div class="post-detail-header">
            <div style="flex: 1;">
                <h2 id="postDetailTitle" style="margin: 0; font-size: 16px; font-weight: 600; color: #050505;">Scheduled Post</h2>
            </div>
            <button class="post-detail-close" onclick="closePostDetailModal()">Ã—</button>
        </div>
        
        <div class="post-detail-body" style="background: white;">
            <!-- Caption Section -->
            <div class="post-detail-section" style="padding: 12px 0; border-bottom: 1px solid #ede8e8;">
                <p id="postDetailCaption" style="margin: 0; font-size: 13px; color: #050505; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;"></p>
            </div>
            
            <!-- Schedule Time Section -->
            <div class="post-detail-section" style="padding: 12px 0; border-bottom: 1px solid #ede8e8;">
                <div style="font-size: 11px; font-weight: 600; color: #65676b; text-transform: uppercase; margin-bottom: 6px;">Scheduled for</div>
                <div id="postDetailTime" style="font-size: 13px; font-weight: 500; color: #050505;"></div>
            </div>
            
            <!-- Status Section -->
            <div class="post-detail-section" style="padding: 12px 0; border-bottom: 1px solid #ede8e8;">
                <div style="font-size: 11px; font-weight: 600; color: #65676b; text-transform: uppercase; margin-bottom: 6px;">Status</div>
                <span id="postDetailStatus" class="post-status-badge" style="display: inline-block;"></span>
            </div>
            
            <!-- Pages Section -->
            <div class="post-detail-section" style="padding: 12px 0; border-bottom: 1px solid #ede8e8;">
                <div style="font-size: 11px; font-weight: 600; color: #65676b; text-transform: uppercase; margin-bottom: 8px;">Publishing to</div>
                <div id="postDetailPages" style="display: flex; flex-direction: column; gap: 6px;"></div>
            </div>
            
            <!-- Media Section -->
            <div class="post-detail-section" id="postDetailMediaSection" style="display: none; padding: 12px 0; border-bottom: 1px solid #ede8e8;">
                <div style="font-size: 11px; font-weight: 600; color: #65676b; text-transform: uppercase; margin-bottom: 8px;">Media</div>
                <div id="postDetailMedia" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 6px; border-radius: 6px; overflow: hidden;"></div>
            </div>
        </div>
        
        <div class="post-detail-footer" style="padding: 12px 16px; background: #fafafa; border-top: 1px solid #ede8e8; display: flex; gap: 8px;">
            <button class="btn btn-secondary" onclick="closePostDetailModal()" style="flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 12px; font-weight: 600; background: white; color: #050505; cursor: pointer; transition: all 0.2s;">
                Close
            </button>
            <button class="btn btn-success" onclick="publishPostNow()" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; background: #31a24c; color: white; cursor: pointer; transition: all 0.2s;">
                <i class="fas fa-paper-plane" style="margin-right: 4px;"></i>Publish
            </button>
            <button class="btn btn-primary" onclick="editPost()" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; background: #1877f2; color: white; cursor: pointer; transition: all 0.2s;">
                <i class="fas fa-edit" style="margin-right: 4px;"></i>Edit
            </button>
            <button class="btn btn-danger" onclick="deletePost()" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; font-size: 12px; font-weight: 600; background: #dc3545; color: white; cursor: pointer; transition: all 0.2s;">
                <i class="fas fa-trash" style="margin-right: 4px;"></i>Delete
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{% include 'dashboard/create_post_modal.html' %}
<script>
    let allPosts = [];
    let currentDate = new Date();
    let filteredPageId = null;
    let filteredPageName = null;

    // Vietnam timezone offset (UTC+7)
    const VIETNAM_OFFSET = 7 * 60 * 60 * 1000;

    function convertToVietnamTime(utcDate) {
        const date = new Date(utcDate);
        return new Date(date.getTime() + VIETNAM_OFFSET);
    }

    // Format time in HH:MM format (Vietnam timezone)
    function formatTime(dateString) {
        // Use 24-hour format consistently with UTC methods
        const date = convertToVietnamTime(new Date(dateString));
        const hours = String(date.getUTCHours()).padStart(2, '0');
        const mins = String(date.getUTCMinutes()).padStart(2, '0');
        return `${hours}:${mins}`;
    }

    // Format date as YYYY-MM-DD in Vietnam timezone
    function formatDateKey(date) {
        // Convert to Vietnam timezone first, then format
        const vietnamDate = convertToVietnamTime(date);
        const year = vietnamDate.getUTCFullYear();
        const month = String(vietnamDate.getUTCMonth() + 1).padStart(2, '0');
        const day = String(vietnamDate.getUTCDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Format date and time in Vietnam timezone (24-hour format)
    function formatDateTimeVietnam(utcDateStr) {
        const utcDate = new Date(utcDateStr);
        const vietnamDate = convertToVietnamTime(utcDate);
        
        // Extract components using UTC methods (since we already added 7 hours)
        const year = vietnamDate.getUTCFullYear();
        const month = String(vietnamDate.getUTCMonth() + 1).padStart(2, '0');
        const day = String(vietnamDate.getUTCDate()).padStart(2, '0');
        const hours = String(vietnamDate.getUTCHours()).padStart(2, '0');
        const mins = String(vietnamDate.getUTCMinutes()).padStart(2, '0');
        
        return {
            date: `${day}/${month}/${year}`,
            time: `${hours}:${mins}`,
            dateTime: `${day}/${month}/${year} at ${hours}:${mins}`
        };
    }

    // Get platform icon class
    function getPlatformIcon(platform) {
        const icons = {
            'facebook': 'fab fa-facebook',
            'instagram': 'fab fa-instagram',
            'tiktok': 'fab fa-tiktok',
            'twitter': 'fab fa-twitter',
            'linkedin': 'fab fa-linkedin'
        };
        return icons[platform.toLowerCase()] || 'fas fa-share-alt';
    }

    // Month navigation
    function nextMonth() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    }

    function previousMonth() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    }

    // Page filtering
    function filterByPage(pageId, pageName, platform) {
        filteredPageId = pageId;
        filteredPageName = pageName;
        
        // Show filter display
        const filterDisplay = document.getElementById('pageFilterDisplay');
        if (filterDisplay) {
            document.getElementById('filterPageName').textContent = `${pageName} (${platform})`;
            filterDisplay.style.display = 'block';
        }
        
        renderCalendar();
    }

    function clearPageFilter() {
        filteredPageId = null;
        filteredPageName = null;
        
        // Hide filter display
        const filterDisplay = document.getElementById('pageFilterDisplay');
        if (filterDisplay) {
            filterDisplay.style.display = 'none';
        }
        
        renderCalendar();
    }

    // Delete a connected page
    function deleteConnectedPage(pageId, pageName) {
        if (!confirm(`Are you sure you want to disconnect "${pageName}"? This will delete all posts, analytics, and data associated with this channel. This action cannot be undone.`)) {
            return;
        }
        
        fetch(`/api/connected-pages/${pageId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`${pageName} has been disconnected`, 'success');
                // Reload the page to reflect changes
                location.reload();
            } else {
                showNotification(data.error || 'Error disconnecting page', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error disconnecting page', 'error');
        });
    }

    // Get filtered posts
    function getFilteredPosts() {
        if (!filteredPageId) {
            return allPosts;
        }
        
        return allPosts.filter(post => {
            return post.pages && post.pages.some(p => p.id === filteredPageId);
        });
    }

    // Create post badge HTML
    function createPostBadge(post) {
        const dateStr = post.scheduled_time || post.sent_time;
        const time = formatTime(dateStr);
        const status = post.status || 'draft';
        
        // Get up to 2 platform icons
        const platforms = [...new Set(post.pages.map(p => p.platform))].slice(0, 2);
        
        const html = `
            <div class="post-badge ${status}" data-post-id="${post.id}" onclick="showPostDetail(${post.id})">
                <span class="badge-time">${time}</span>
                <span class="badge-dot ${status}"></span>
                <div class="badge-platforms">
                    ${platforms.map(platform => `<i class="${getPlatformIcon(platform)}"></i>`).join('')}
                </div>
            </div>
        `;
        return html;
    }

    // Render grid calendar
    function renderCalendar() {
        const container = document.getElementById('calendarTimeline');
        if (!container) return;
        
        container.innerHTML = '';
        
        const filteredPosts = getFilteredPosts();
        
        // Update header month/year
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
        document.getElementById('monthYearDisplay').textContent = 
            `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        
        // Get calendar data
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startingDayOfWeek = firstDay.getDay(); // 0 = Sunday
        const daysInMonth = lastDay.getDate();
        const totalCells = Math.ceil((startingDayOfWeek + daysInMonth) / 7) * 7;
        
        // Group posts by date (include draft, scheduled, and sent posts)
        const postsMap = {};
        filteredPosts.forEach(post => {
            // Show all posts that have a scheduled_time or sent_time
            // This includes drafts with scheduled_time, scheduled posts, and sent posts
            let dateStr = post.scheduled_time || post.sent_time;
            
            // Skip posts without any date
            if (!dateStr) {
                return;
            }
            
            const date = convertToVietnamTime(new Date(dateStr));
            const dateKey = formatDateKey(date);
            
            if (!postsMap[dateKey]) {
                postsMap[dateKey] = [];
            }
            postsMap[dateKey].push(post);
        });
        
        // Create grid
        const grid = document.createElement('div');
        grid.className = 'calendar-grid';
        
        // Add day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const headerRow = document.createElement('div');
        headerRow.className = 'calendar-day-header-grid';
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-day-header-cell';
            header.textContent = day;
            headerRow.appendChild(header);
        });
        grid.appendChild(headerRow);
        
        // Create day cells
        let cellCount = 0;
        for (let i = 0; i < totalCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'calendar-day-cell';
            
            // Calculate day number
            const dayNum = i - startingDayOfWeek + 1;
            
            if (dayNum < 1 || dayNum > daysInMonth) {
                // Empty cell (previous/next month)
                cell.classList.add('other-month');
            } else {
                // Cell for current month
                const dayDate = new Date(year, month, dayNum);
                const dateKey = formatDateKey(dayDate);
                const postsForDay = postsMap[dateKey] || [];
                
                // Add day number
                const dayNumberDiv = document.createElement('div');
                dayNumberDiv.className = 'calendar-day-number';
                dayNumberDiv.textContent = dayNum;
                cell.appendChild(dayNumberDiv);
                
                // Add posts container
                const postsContainer = document.createElement('div');
                postsContainer.className = 'calendar-day-posts-grid';
                
                if (postsForDay.length > 0) {
                    postsForDay.forEach(post => {
                        const badge = document.createElement('div');
                        badge.innerHTML = createPostBadge(post);
                        postsContainer.appendChild(badge.firstElementChild);
                    });
                }
                
                cell.appendChild(postsContainer);
            }
            
            grid.appendChild(cell);
            cellCount++;
        }
        
        // Append the entire grid to the container
        container.appendChild(grid);
    }

    // Show post detail modal
    function showPostDetail(postId) {
        const post = allPosts.find(p => p.id === postId);
        if (!post) return;
        
        const status = post.status || 'draft';
        
        // Show different modal based on status
        if (status === 'sent') {
            // Published post - show new detailed modal
            showPublishedPostDetail(post);
        } else {
            // Scheduled/draft post - show edit modal
            showScheduledPostDetail(post);
        }
    }

    function showPublishedPostDetail(post) {
        try {
            const dateStr = post.sent_time;
            if (!dateStr) {
                console.error('No sent_time found in post:', post);
                return;
            }
            
            const dateTime = formatDateTimeVietnam(dateStr);
            
            // Page info
            const pageName = post.pages && post.pages.length > 0 ? post.pages[0].name : 'Unknown Page';
            const platform = post.pages && post.pages.length > 0 ? post.pages[0].platform : 'facebook';
            
            // Update header with page name and time
            const pageNameEl = document.getElementById('publishedPostPageName');
            const iconEl = document.getElementById('publishedPostPageIcon');
            const timeEl = document.getElementById('publishedPostTime');
            const captionEl = document.getElementById('publishedPostCaption');
            
            if (!pageNameEl || !iconEl || !timeEl || !captionEl) {
                console.error('Modal elements not found');
                return;
            }
            
            pageNameEl.textContent = pageName;
            iconEl.className = getPlatformIcon(platform);
            timeEl.textContent = dateTime.dateTime;
            
            // Populate caption
            captionEl.textContent = post.caption || '';
            
            // Media
            if (post.media && post.media.length > 0) {
                const mediaHtml = post.media.map(m => `
                    <div style="overflow: hidden; border-radius: 6px; background: #f0f2f5;">
                        ${m.type === 'image' ? `<img src="${m.url}" alt="Post media" style="width: 100%; height: auto; display: block;">` : `<video controls style="width: 100%; height: auto; display: block;"><source src="${m.url}" type="video/mp4"></video>`}
                    </div>
                `).join('');
                document.getElementById('publishedPostMedia').innerHTML = mediaHtml;
                document.getElementById('publishedPostMediaSection').style.display = 'block';
            } else {
                document.getElementById('publishedPostMediaSection').style.display = 'none';
            }
            
            // Fetch real metrics from backend
            fetchPostAnalytics(post.id).then(analytics => {
                document.getElementById('publishedPostLikes').textContent = formatMetricValue(analytics.likes);
                document.getElementById('publishedPostComments').textContent = formatMetricValue(analytics.comments);
                document.getElementById('publishedPostShares').textContent = formatMetricValue(analytics.shares);
                document.getElementById('publishedPostImpressions').textContent = formatMetricValue(analytics.impressions);
                document.getElementById('publishedPostClicks').textContent = formatMetricValue(analytics.clicks);
            }).catch(err => {
                console.error('Error fetching metrics:', err);
                // Show dashes if no analytics
                document.getElementById('publishedPostLikes').textContent = '-';
                document.getElementById('publishedPostComments').textContent = '-';
                document.getElementById('publishedPostShares').textContent = '-';
                document.getElementById('publishedPostImpressions').textContent = '-';
                document.getElementById('publishedPostClicks').textContent = '-';
            });
            
            // View post button - show and set URL if available
            const viewButton = document.getElementById('publishedPostViewButton');
            if (post.platform_post_id) {
                viewButton.href = getPostUrl(post, page);
                viewButton.style.display = 'inline-flex';
            } else {
                viewButton.style.display = 'none';
            }
            
            // Show modal
            const modal = document.getElementById('publishedPostDetailModal');
            if (modal) {
                modal.classList.add('active');
            } else {
                console.error('publishedPostDetailModal not found');
            }
        } catch (error) {
            console.error('Error in showPublishedPostDetail:', error);
        }
    }

    function formatMetricValue(value) {
        if (!value) return '-';
        if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
        if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
        return String(value);
    }

    function showScheduledPostDetail(post) {
        try {
            const dateStr = post.scheduled_time || post.sent_time;
            if (!dateStr) {
                console.error('No date found for post:', post);
                return;
            }
            
            const dateTime = formatDateTimeVietnam(dateStr);
            const status = post.status || 'draft';
            
            const detailModal = document.getElementById('postDetailModal');
            if (!detailModal) {
                console.error('Post detail modal not found');
                return;
            }
            
            // Populate modal with post data
            document.getElementById('postDetailTitle').textContent = post.caption.substring(0, 50) + (post.caption.length > 50 ? '...' : '');
            document.getElementById('postDetailCaption').textContent = post.caption;
            document.getElementById('postDetailTime').textContent = dateTime.dateTime;
            document.getElementById('postDetailStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
            document.getElementById('postDetailStatus').className = `post-status-badge ${status}`;
            
            // Show pages with improved styling
            const pagesHtml = post.pages.map(p => `
                <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f0f2f5; border-radius: 6px; font-size: 13px;">
                    <i class="${getPlatformIcon(p.platform)}" style="font-size: 16px; color: #1877f2;"></i>
                    <span style="font-weight: 500; color: #050505;">${p.name}</span>
                    <span style="font-size: 11px; color: #65676b; background: white; padding: 2px 6px; border-radius: 4px;">${p.platform}</span>
                </div>
            `).join('');
            document.getElementById('postDetailPages').innerHTML = pagesHtml || '<p style="color: #65676b;">No pages selected</p>';
            
            // Show media
            if (post.media && post.media.length > 0) {
                const mediaHtml = post.media.map(m => `
                    <div style="overflow: hidden; border-radius: 6px; background: #f0f2f5;">
                        ${m.type === 'image' ? `<img src="${m.url}" alt="Post media" style="width: 100%; height: auto; display: block;">` : `<video controls style="width: 100%; height: auto; display: block;"><source src="${m.url}" type="video/mp4"></video>`}
                    </div>
                `).join('');
                document.getElementById('postDetailMedia').innerHTML = mediaHtml;
                document.getElementById('postDetailMediaSection').style.display = 'block';
            } else {
                document.getElementById('postDetailMediaSection').style.display = 'none';
            }
            
            // Store current post ID for actions
            document.getElementById('postDetailModal').dataset.postId = post.id;
            
            // Show modal
            detailModal.classList.add('active');
        } catch (error) {
            console.error('Error in showScheduledPostDetail:', error);
        }
    }

    // Close published post detail modal
    function closePublishedPostDetailModal() {
        const modal = document.getElementById('publishedPostDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function showMetricDetail(metricType, value) {
        const modal = document.getElementById('metricDetailModal');
        const titleEl = document.getElementById('metricDetailTitle');
        const contentEl = document.getElementById('metricDetailContent');

        // Capitalize first letter for title
        const title = metricType.charAt(0).toUpperCase() + metricType.slice(1);
        titleEl.textContent = title;

        // Create detail content based on metric type
        let detailHTML = '';

        if (metricType === 'likes') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Likes</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Reaction Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Likes represent the number of reactions (Like, Love, Haha, Wow, Sad, Angry) on your post.</p>
            `;
        } else if (metricType === 'comments') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Comments</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Comment Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Comments are conversations that happen on your post.</p>
            `;
        } else if (metricType === 'shares') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Shares</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Share Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Shares measure how many times people shared your post with others.</p>
            `;
        } else if (metricType === 'impressions') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Impressions</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Reach</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Impressions are the number of times your post was displayed in users' feeds.</p>
            `;
        } else if (metricType === 'clicks') {
            detailHTML = `
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Total Clicks</span>
                    <span class="metric-detail-value">${value}</span>
                </div>
                <div class="metric-detail-item">
                    <span class="metric-detail-label">Click-Through Rate</span>
                    <span class="metric-detail-value">-</span>
                </div>
                <p style="font-size: 12px; color: #65676b; margin-top: 12px;">Clicks include links, hashtags, and other interactive elements on your post.</p>
            `;
        }

        contentEl.innerHTML = detailHTML;

        // Show modal
        if (modal) {
            modal.classList.add('active');
        }
    }

    function closeMetricDetailModal() {
        const modal = document.getElementById('metricDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    function getPostUrl(post, page) {
        if (!post.platform_post_id) return '#';
        
        // Format: platform_id_post_id
        // For Facebook: https://facebook.com/page_username/posts/post_id
        const parts = post.platform_post_id.split('_');
        
        if (page.platform.toLowerCase() === 'facebook') {
            // Extract post ID from platform_post_id
            const postId = parts[parts.length - 1];
            return `https://facebook.com/${page.page_username}/posts/${postId}`;
        } else if (page.platform.toLowerCase() === 'instagram') {
            return `https://instagram.com/p/${post.platform_post_id}/`;
        } else if (page.platform.toLowerCase() === 'tiktok') {
            return `https://tiktok.com/@${page.page_username}/video/${post.platform_post_id}`;
        }
        
        return '#';
    }

    async function fetchPostAnalytics(postId) {
        try {
            const response = await fetch(`/api/posts/${postId}/analytics`);
            if (response.ok) {
                const data = await response.json();
                return data.analytics || {};
            }
        } catch (e) {
            console.error('Error fetching analytics:', e);
        }
        return {};
    }

    // Close post detail modal
    function closePostDetailModal() {
        const modal = document.getElementById('postDetailModal');
        if (modal) {
            modal.classList.remove('active');
        }
    }

    // Edit post
    function editPost() {
        const postId = document.getElementById('postDetailModal').dataset.postId;
        const post = allPosts.find(p => p.id === postId);
        
        if (!post) return;
        
        // Open create post modal in edit mode
        openCreatePostModal('edit', post);
        closePostDetailModal();
    }

    // Delete post
    function deletePost() {
        const postId = document.getElementById('postDetailModal').dataset.postId;
        if (!confirm('Are you sure you want to delete this post?')) return;
        
        fetch(`/api/posts/${postId}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closePostDetailModal();
                    loadPostsOnCalendar();
                    showNotification('Post deleted successfully', 'success');
                }
            })
            .catch(err => {
                console.error('Error deleting post:', err);
                showNotification('Error deleting post', 'error');
            });
    }

    // Publish post now
    function publishPostNow() {
        const postId = document.getElementById('postDetailModal').dataset.postId;
        
        fetch(`/api/posts/${postId}/publish`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    closePostDetailModal();
                    loadPostsOnCalendar();
                    showNotification('Post published successfully', 'success');
                }
            })
            .catch(err => {
                console.error('Error publishing post:', err);
                showNotification('Error publishing post', 'error');
            });
    }

    // Show notification
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Tab Switching Functions
    function switchToCalendarView() {
        document.getElementById('calendarTab').classList.add('active');
        document.getElementById('sheetTab').classList.remove('active');
        document.getElementById('calendarContent').style.display = 'flex';
        document.getElementById('scheduleSheetContainer').style.display = 'none';
        document.querySelector('.calendar-header').style.display = 'flex';
    }

    function switchToSheetView() {
        document.getElementById('sheetTab').classList.add('active');
        document.getElementById('calendarTab').classList.remove('active');
        document.getElementById('calendarContent').style.display = 'none';
        document.querySelector('.calendar-header').style.display = 'none';
        document.getElementById('scheduleSheetContainer').style.display = 'flex';
        
        // Initialize sheet if not already done
        if (typeof initializeSheetTab === 'function') {
            initializeSheetTab();
        }
    }

    // Fetch posts and display them on calendar
    function loadPostsOnCalendar() {
        fetch('/api/posts')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allPosts = data.posts;
                    renderCalendar();
                }
            })
            .catch(error => {
                console.error('Error loading posts:', error);
                showNotification('Error loading posts', 'error');
            });
    }

    // Refresh historical posts from connected pages
    function refreshHistoricalPosts() {
        const btn = event.target.closest('button');
        const originalContent = btn.innerHTML;
        
        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        
        fetch('/api/posts/refresh/historical', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            
            if (data.success) {
                const message = `âœ“ Refreshed ${data.pages_processed} page(s), added ${data.total_posts_added} post(s)`;
                showNotification(message, 'success');
                
                // Reload the posts to display newly fetched historical posts
                loadPostsOnCalendar();
            } else {
                showNotification(data.error || 'Error refreshing historical posts', 'error');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = originalContent;
            console.error('Error refreshing historical posts:', error);
            showNotification('Error refreshing historical posts', 'error');
        });
    }

    // Load posts on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadPostsOnCalendar();
    });
</script>

<style>
    .post-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background-color: #f0f7ff;
        border: 1px solid #007bff;
        border-radius: 12px;
        padding: 4px 8px;
        margin-top: 4px;
        font-size: 11px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .post-badge:hover {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
    }

    .badge-dot {
        display: inline-block;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: #28a745;
    }

    .badge-dot.scheduled {
        background-color: #ffc107;
    }

    .badge-dot.sent {
        background-color: #28a745;
    }

    .badge-text {
        font-weight: 500;
        white-space: nowrap;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-scheduled {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-sent {
        background-color: #d4edda;
        color: #155724;
    }

    /* Enhanced Calendar Day Styling */
    .calendar-day {
        display: flex;
        gap: 0;
        min-height: 200px;
        margin-bottom: 16px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        background: white;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .calendar-day-header {
        width: 100px;
        padding: 16px 12px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .day-name {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        opacity: 0.9;
    }

    .day-date {
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }

    .calendar-day-posts {
        flex: 1;
        display: flex;
        gap: 12px;
        padding: 12px;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-behavior: smooth;
        align-items: flex-start;
    }

    .calendar-day-posts::-webkit-scrollbar {
        height: 6px;
    }

    .calendar-day-posts::-webkit-scrollbar-track {
        background: #f0f0f0;
    }

    .calendar-day-posts::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 3px;
    }

    .calendar-day-posts::-webkit-scrollbar-thumb:hover {
        background: #999;
    }

    .empty-posts {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ccc;
        font-size: 14px;
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    /* Post Card */
    .post-card {
        flex-shrink: 0;
        width: 300px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }

    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        border-color: #667eea;
        transform: translateY(-2px);
    }

    .post-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding-bottom: 6px;
        border-bottom: 1px solid #f0f0f0;
    }

    .post-time {
        font-size: 12px;
        font-weight: 600;
        color: #667eea;
    }

    .post-card-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .post-card-status.scheduled {
        background-color: #fff3cd;
        color: #856404;
    }

    .post-card-status.sent {
        background-color: #d4edda;
        color: #155724;
    }

    .post-card-body {
        flex: 1;
    }

    .post-card-caption {
        font-size: 13px;
        line-height: 1.4;
        color: #333;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        word-wrap: break-word;
    }

    .post-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 6px;
        border-top: 1px solid #f0f0f0;
        font-size: 12px;
    }

    .post-platforms {
        display: flex;
        gap: 6px;
    }

    .post-platforms i {
        font-size: 14px;
        color: #667eea;
    }

    .post-media-count {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 11px;
        color: #999;
    }

    .post-media-count i {
        font-size: 12px;
    }

    /* Post Detail Modal */
    .post-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    .post-detail-modal.active {
        display: flex;
    }

    .post-detail-modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .post-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
        background: #ffffff;
        color: #050505;
        border-radius: 12px 12px 0 0;
    }

    .post-detail-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: #050505;
    }

    .post-detail-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #999;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .post-detail-close:hover {
        background: #f5f5f5;
        color: #050505;
    }

    .post-detail-body {
        flex: 1;
        padding: 16px 20px;
        overflow-y: auto;
    }

    .post-detail-section {
        margin-bottom: 16px;
    }

    .post-detail-section:last-child {
        margin-bottom: 0;
    }

    .post-detail-section h4 {
        margin: 0 0 8px 0;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        color: #65676b;
        letter-spacing: 0.3px;
    }

    .post-detail-section p {
        margin: 0;
        font-size: 13px;
        line-height: 1.5;
        color: #050505;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .post-status-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .post-status-badge.scheduled {
        background-color: #fff5e6;
        color: #cc8800;
    }

    .post-status-badge.sent {
        background-color: #e8f5e9;
        color: #2e7d32;
    }

    .post-status-badge.draft {
        background-color: #f5f5f5;
        color: #666;
    }

    #postDetailPages {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .post-page-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #333;
    }

    .post-page-item i {
        font-size: 16px;
        color: #667eea;
        width: 20px;
        text-align: center;
    }

    #postDetailMedia {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .post-detail-media {
        border-radius: 6px;
        overflow: hidden;
        background: #f0f0f0;
        aspect-ratio: 1;
    }

    .post-detail-media img,
    .post-detail-media video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .post-detail-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 12px 20px;
        border-top: 1px solid #ede8e8;
        background: #fafafa;
        border-radius: 0 0 12px 12px;
    }

    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-secondary {
        background-color: #e7e7e7;
        color: #333;
    }

    .btn-secondary:hover {
        background-color: #d0d0d0;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #218838;
    }

    /* Published Post Modal */
    .published-post-modal {
        max-width: 650px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.12) !important;
    }

    .published-post-modal .post-detail-header {
        background: #ffffff;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
    }

    .published-post-modal .post-detail-header h2 {
        font-size: 16px;
        font-weight: 600;
        color: #050505;
        margin: 0;
    }

    .published-post-modal .post-detail-body {
        background: #ffffff;
        padding: 0;
    }

    /* Published post content container */
    .published-post-content {
        padding: 12px 0;
        border-bottom: 1px solid #ede8e8;
    }

    .published-post-header-info {
        padding: 0 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .published-post-page-info {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .published-post-page-info i {
        font-size: 14px;
        color: #999;
    }

    .published-post-page-name {
        font-size: 12px;
        font-weight: 600;
        color: #050505;
    }

    .published-post-time {
        font-size: 11px;
        color: #65676b;
    }

    .published-post-caption {
        padding: 0 16px;
        margin-bottom: 8px;
        font-size: 13px;
        line-height: 1.5;
        color: #050505;
        word-wrap: break-word;
        white-space: pre-wrap;
    }

    #publishedPostMediaSection {
        padding: 0 16px;
        margin-bottom: 8px;
    }

    #publishedPostMedia {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        max-height: 400px;
        overflow: hidden;
    }

    #publishedPostMedia > div {
        overflow: hidden;
        border-radius: 6px;
        background: #f0f2f5;
    }

    #publishedPostMedia img,
    #publishedPostMedia video {
        width: 100%;
        height: auto;
        display: block;
    }

    /* Metrics Grid - Facebook Style */
    .post-metrics-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 1px;
        padding: 1px;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        margin: 16px 0;
        background: #e5e5e5;
        border-radius: 8px;
        overflow: hidden;
    }

    .post-metric {
        text-align: center;
        padding: 16px 8px;
        background: #ffffff;
        border-radius: 0;
        transition: all 0.15s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
    }

    .post-metric:hover {
        background: #f8f9fa;
    }

    .metric-value {
        font-size: 18px;
        font-weight: 700;
        color: #050505;
        margin-bottom: 4px;
        line-height: 1;
    }

    .metric-label {
        font-size: 11px;
        color: #65676b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        line-height: 1.2;
    }

    /* Action buttons */
    .published-post-actions {
        display: flex;
        gap: 8px;
        padding: 12px 0;
        margin-top: 12px;
        border-top: 1px solid #ede8e8;
        justify-content: space-between;
    }

    .published-post-actions.button {
        flex: 1;
        padding: 10px 16px;
        border: 1px solid #e4e6eb;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        background: #e4e6eb;
        color: #050505;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .published-post-actions.button:hover {
        background: #d0d2d7;
        border-color: #bcc0c4;
    }

    .published-post-actions.button i {
        margin-right: 6px;
    }

    /* Detail metrics modal */
    .metric-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1001;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    .metric-detail-modal.active {
        display: flex;
    }

    .metric-detail-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 90%;
        max-height: 70vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }

    .metric-detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #ede8e8;
        background: #ffffff;
        border-radius: 12px 12px 0 0;
    }

    .metric-detail-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #050505;
    }

    .metric-detail-body {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
    }

    .metric-detail-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .metric-detail-item:last-child {
        border-bottom: none;
    }

    .metric-detail-label {
        font-size: 13px;
        color: #65676b;
        font-weight: 500;
    }

    .metric-detail-value {
        font-size: 16px;
        font-weight: 700;
        color: #050505;
    }
    .published-post-actions {
        padding: 12px 16px;
        display: flex;
        gap: 8px;
    }

    .published-post-actions button {
        flex: 1;
        padding: 10px 16px;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    #publishedPostViewButton {
        background: #1877f2;
        color: white;
    }

    #publishedPostViewButton:hover {
        background: #0a66c2;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(24, 119, 242, 0.3);
    }

    /* Notification Toast */
    .notification {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
        z-index: 2000;
        transition: bottom 0.3s ease;
        max-width: 400px;
    }

    .notification.show {
        bottom: 30px;
    }

    .notification-success {
        border-left: 4px solid #28a745;
        color: #155724;
    }

    .notification-success i {
        color: #28a745;
    }

    .notification-error {
        border-left: 4px solid #dc3545;
        color: #721c24;
    }

    .notification-error i {
        color: #dc3545;
    }

    .notification-info {
        border-left: 4px solid #17a2b8;
        color: #0c5460;
    }

    .notification-info i {
        color: #17a2b8;
    }
</style>
{% endblock %}
